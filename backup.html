<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Imunisasi TT</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Imunisasi TT">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="apple-touch-startup-image" href="/icons/icon-512.png">
    <style>
        /* CSS Variables for Global Font Sizing */
        :root {
            --base-font-size: 12px; /* Default base font size, adjusted by JS */
        }

        /* Apply base font size to HTML root element for global REM scaling */
        html {
            font-size: var(--base-font-size); 
        }

        body {
            font-family: 'Inter', sans-serif; /* Using Inter as the primary font */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-800 */
        }

        /* Hide the default date input icon for consistency, if desired */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg); /* Example: change color */
            cursor: pointer;
        }

        /* Ensure select arrow is visible and styled */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3Csvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for the arrow */
        }

        /* --- START OF NEW/MODIFIED CSS FOR DATA LIST CARDS --- */
        .data-card-item {
            display: flex;
            flex-direction: column; /* Keep as column for overall card structure */
            gap: 0.5rem;
            padding: 0.75rem; /* Make card smaller */
            border-radius: 0.75rem; /* Slightly more rounded */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08); /* Stronger, more professional shadow */
            cursor: pointer; /* Cursor for the entire card to indicate it's clickable for details */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-left-width: 6px; /* Thicker border on left */
            background-color: #ffffff; /* Explicit white background */
        }

        .data-card-item:hover {
            transform: translateY(-3px); /* More pronounced lift on hover */
            box-shadow: 0 10px 15px rgba(0,0,0,0.15), 0 4px 6px rgba(0,0,0,0.1); /* Deeper shadow on hover */
        }

        .data-card-name {
            font-weight: 700; /* Bolder name */
            font-size: 1.125rem; /* text-lg */
            color: #2d3748; /* gray-800 */
        }

        .data-card-right-block {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align children to the right */
            gap: 0.2rem; /* Small gap between elements */
        }

        .tt-boxes-container {
            display: flex;
            gap: 0.2rem; /* Reduced space between boxes */
            justify-content: flex-end; /* Ensure boxes align right within their container */
        }

        .tt-box {
            width: 1.5rem; /* Smaller boxes */
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* More rounded corners for boxes */
            font-size: 0.6rem; /* Smaller font size */
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Clearer shadow for boxes */
            flex-shrink: 0; /* Prevent shrinking on small screens */
        }

        .sync-badge-container {
            /* Removed margin-top: 0.2rem; to make it more compact */
        }

        .badge-sync {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.75rem; /* More padding */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.8rem; /* Slightly larger font for badge */
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow for badge */
        }

        .badge-sync.synced {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }

        .badge-sync.pending {
            background-color: #fefcbf; /* yellow-100 */
            color: #92400e; /* yellow-800 */
        }

        /* Reverted: Removed specific cursor for phone/WhatsApp action links.
           They will inherit 'pointer' from the parent card, but stopPropagation will handle the click. */
        /* Reverted: Removed specific cursor for the phone number text itself.
           It will inherit 'pointer' from the parent card, but is not directly clickable. */

        /* General input/select/textarea styling for professionalism */
        input[type="text"],
        input[type="date"],
        textarea,
        select {
            border-radius: 0.5rem;
            border: 1px solid #cbd5e0; /* gray-300 */
            padding: 0.75rem 1rem; /* More padding */
            font-size: 1rem; /* Base font size for inputs */
            color: #2d3748; /* gray-800 */
            transition: all 0.2s ease-in-out;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #48bb78; /* green-500 */
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.5); /* green-500 with opacity */
        }

        /* Error input styling */
        input.input-error, select.input-error, textarea.input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5); /* red-500 with opacity */
        }

        /* Button styling for professionalism */
        button {
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: 600;
            padding: 0.8rem 1.5rem; /* Increased padding */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Subtle shadow */
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 10px rgba(0,0,0,0.15); /* Deeper shadow on hover */
        }

        /* Modal styling */
        .modal-content {
            border-radius: 1rem; /* More rounded modal */
            box-shadow: 0 20px 25px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.1); /* Stronger shadow */
        }

        /* Font size control buttons styling */
        .font-control-btn {
            padding: 0.1rem 0.4rem; /* Smaller padding */
            border-radius: 0.5rem;
            background-color: #e2e8f0; /* gray-200 */
            color: #4a5568; /* gray-700 */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.65rem; /* Even smaller font size */
        }

        .font-control-btn:hover:not(:disabled) {
            background-color: #cbd5e0; /* gray-300 */
        }

        .font-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Media queries for responsiveness */
        @media (max-width: 640px) {
            .data-card-item {
                padding: 0.6rem; /* Even smaller padding on mobile */
            }
            .data-card-name {
                font-size: 1rem; /* Slightly smaller name on mobile */
            }
            /* Adjusted padding for main container on mobile */
            .main-container {
                padding: 1rem;
            }
            /* Adjust fixed headers/footers for mobile */
            .fixed-top-bar, .fixed-bottom-bar {
                padding: 1rem;
            }
            .fixed-bottom-bar .flex {
                gap: 0.75rem;
            }
            .fixed-bottom-bar button {
                flex-grow: 1; /* Allow buttons to grow to fill space equally */
            }
        }

        /* Styles for icon buttons in navigation */
        .nav-button {
            display: flex;
            flex-direction: column; /* Keep column for vertical centering of icon */
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Adjusted padding for smaller buttons */
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1; /* Allow buttons to take equal space */
            max-width: 90px; /* Limit max width for smaller buttons */
            text-align: center;
            color: white; /* Default text color for nav buttons */
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 10px rgba(0,0,0,0.15);
        }

        .nav-button i {
            font-size: 1.5rem; /* Icon size */
            margin-bottom: 0; /* Remove margin as there's no text below */
        }

        /* Report Table Specific Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            border: 1px solid #e2e8f0; /* gray-200 */
            padding: 0.3rem 0.5rem; /* Reduced padding for more compact table */
            text-align: center; /* Angka di tengah */
            font-size: 0.8rem; /* Smaller font size for table content */
            min-width: 40px; /* Minimum width for numerical columns */
        }

        /* Lebar khusus untuk kolom JUMLAH */
        /* Menargetkan kolom ke-11 (BUMIL), ke-12 (#BUMIL), dan ke-13 (TOTAL) di baris kedua header dan body */
        #reportTable thead tr:nth-child(2) th:nth-child(16),
        #reportTable tbody td:nth-child(15),
        #reportTable thead tr:nth-child(2) th:nth-child(17),
        #reportTable tbody td:nth-child(16),
        #reportTable thead tr:nth-child(2) th:nth-child(18),
        #reportTable tbody td:nth-child(17) {
            min-width: 50px; /* Sesuaikan nilai ini sesuai kebutuhan Anda, contoh: 70px */
        }

        th {
            background-color: #e2e8f0; /* gray-200 */
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }
        tbody tr:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .total-row th, .total-row td {
            background-color: #bfdbfe; /* blue-200 */
            font-weight: 700;
            color: #1e40af; /* blue-800 */
            border-top: 2px solid #60a5fa; /* blue-400 */
        }

        /* Sticky header for each view */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f3f4f6; /* Match body background */
            padding-top: 1rem;
            padding-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom style for SiTTa text shadow */
        .sitta-text-shadow {
            /* Increased offset and spread for more prominence */
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5); /* Darker and more pronounced shadow */
        }

        /* Network Status Indicator Styles */
        #networkStatusIndicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px; /* rounded-full */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #networkStatusIndicator.online {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }

        #networkStatusIndicator.offline {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        #networkStatusIndicator i {
            font-size: 0.875rem; /* text-sm */
        }

    /* Sticky column styles for report table */
    .sticky-col {
        position: sticky;
        left: 0;
        /* COBA SALAH SATU KODE WARNA DI BAWAH INI */
        /* background-color: #2C3E50;  Midnight Blue - sedikit lebih terang dari sebelumnya */
        /* background-color: #34495E;  Wet Asphalt - lebih terang lagi, masih gelap */
        /* background-color: #364F6B;  Dark Cerulean - pilihan biru gelap yang bagus */
        background-color: #4682B4; /* Steel Blue - biru sedang yang lebih terlihat */
        color: #ffffff; /* Warna teks putih agar kontras dengan latar belakang gelap */
        z-index: 1; /* Pastikan di atas sel lain */
    }

    /* Ensure sticky header cells are above sticky body cells */
    #reportTable thead th.sticky-col {
        z-index: 11; /* Lebih tinggi dari sel sticky body */
        /* COBA SALAH SATU KODE WARNA DI BAWAH INI (sesuaikan dengan sticky-col di atas) */
        /* background-color: #2C3E50; */
        /* background-color: #34495E; */
        /* background-color: #364F6B; */
        background-color: #4682B4; /* Sesuaikan dengan pilihan Anda */
        color: #ffffff; /* Pastikan teks header putih */
    }
    /* Tambahkan ini untuk memastikan warna latar belakang tetap saat baris ganjil/genap */
    #reportTable tbody tr:nth-child(even) .sticky-col {
        /* COBA SALAH SATU KODE WARNA DI BAWAH INI (sesuaikan dengan sticky-col di atas) */
        /* background-color: #2C3E50; */
        /* background-color: #34495E; */
        /* background-color: #364F6B; */
        background-color: #4682B4; /* Sesuaikan dengan pilihan Anda */
        color: #ffffff;
    }
    #reportTable tbody tr:hover .sticky-col {
        /* COBA SALAH SATU KODE WARNA DI BAWAH INI (sedikit lebih terang dari pilihan utama, atau sama) */
        /* background-color: #34495E; */ /* Contoh: jika utama #2C3E50, ini bisa jadi hover */
        /* background-color: #4A6581; */ /* Contoh: jika utama #364F6B, ini bisa jadi hover */
        background-color: #5A9BD6; /* Contoh: jika utama #4682B4, ini bisa jadi hover */
        color: #ffffff;
    }
    .total-row .sticky-col {
        /* COBA SALAH SATU KODE WARANG DI BAWAH INI (sesuaikan dengan sticky-col di atas) */
        /* background-color: #2C3E50; */
        /* background-color: #34495E; */
        /* background-color: #364F6B; */
        background-color: #4682B4; /* Sesuaikan dengan pilihan Anda */
        color: #ffffff;
    }

    /* NEW: Styles for column separators */
    /* Garis setelah kolom TT5 BUMIL (kolom ke-6 di baris kedua header) */
    #reportTable thead th:nth-child(6),
    #reportTable tbody td:nth-child(7) {
        border-right: 2px solid #60a5fa; /* Blue-400 for separator after BUMIL TT5 */
    }
    /* Garis setelah kolom TT5 #BUMIL (kolom ke-11 di baris kedua header) */
    #reportTable thead th:nth-child(12),
    #reportTable tbody td:nth-child(13) {
        border-right: 2px solid #60a5fa; /* Blue-400 for separator after #BUMIL TT5 */
    }
    /* Garis setelah kolom TL #BUMIL (kolom ke-13 di baris kedua header) */
    #reportTable thead th:nth-child(15),
    #reportTable tbody td:nth-child(16) {
        border-right: 2px solid #60a5fa; /* Blue-400 for separator after TL #BUMIL */
    }

    /* Ensure total row also gets these separators */
    .total-row td:nth-child(7),
    .total-row td:nth-child(13),
    .total-row td:nth-child(16) { /* Added TL total row separator */
        border-right: 2px solid #60a5fa; /* Match the separator color */
    }
    /* Pastikan kolom pertama (Bulan/Desa) tetap rata kiri untuk data, tapi header bisa center */
    #reportTable tbody td:first-child {
        text-align: left;
    }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- Fixed Top Bar -->
<div id="topNavBar" 
     class="fixed top-0 left-0 right-0 z-20 bg-gradient-to-r from-blue-100 to-blue-200 
            px-2 py-1 shadow-md flex items-center justify-between 
            rounded-bl-xl rounded-br-xl text-xs">

  <!-- Kiri: Logo + Judul -->
  <div class="flex items-center gap-2">
    <img 
      src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Official_Logo_of_Sidenreng_Rappang_Regency.png/1044px-Official_Logo_of_Sidenreng_Rappang_Regency.png"
      alt="Logo Pemda Sidrap"
      class="h-6 md:h-7"
    >
    <span class="font-bold text-blue-800 text-sm sm:text-base">siTTa</span>
  </div>

  <!-- Kanan: Network, User Info, Settings -->
  <div class="flex items-center gap-2">
    <!-- Network Status -->
    <span id="networkStatusIndicator" class="hidden flex flex-col items-center text-gray-600">
      <i class="fas"></i>
      <span id="networkStatusText" class="text-[10px]"></span>
    </span>

    <!-- User Info -->
    <div class="flex flex-col items-end leading-tight">
      <span id="loggedInDesa" class="font-semibold text-gray-700"></span>
      <span id="loggedInEmail" class="italic text-gray-500 text-[10px]"></span>
    </div>

    <!-- Settings Menu -->
    <div class="relative">
      <button id="settingsBtn" 
              class="px-2 py-1 bg-white border rounded hover:bg-gray-100">⚙️</button>
      <!-- Dropdown -->
      <div id="settingsDropdown" 
           class="hidden absolute right-0 mt-2 w-44 bg-white border rounded shadow-md text-xs">

 <!-- Label Font Size -->
<div class="px-1 py-1 text-gray-600 text-[10px] font-semibold">Font Size</div>

<!-- Font Size Controls (lebih besar) -->
<div class="flex items-center gap-1 px-2 py-1">
  <button id="zoomOutBtn" 
          class="font-control-btn px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" 
          onclick="adjustFontSize(-1)">A-</button>
  <button id="resetZoomBtn" 
          class="font-control-btn px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" 
          onclick="adjustFontSize(0)">A</button>
  <button id="zoomInBtn" 
          class="font-control-btn px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" 
          onclick="adjustFontSize(1)">A+</button>
</div>
        <hr class="my-1">

        <!-- Install PWA -->
        <button id="installBtn" class="hidden block w-full px-2 py-1 hover:bg-gray-100 text-left">
          📥 Install Aplikasi
        </button>
        <hr class="my-1">

        <!-- Logout -->
        <button id="logoutBtn" 
                class="block w-full px-2 py-1 text-red-600 hover:bg-red-100 text-left">
         [X]  Keluar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  // Toggle dropdown Settings
  document.getElementById("settingsBtn").addEventListener("click", function() {
    document.getElementById("settingsDropdown").classList.toggle("hidden");
  });

  // Tutup dropdown kalau klik di luar
  document.addEventListener("click", function(e) {
    const dropdown = document.getElementById("settingsDropdown");
    const btn = document.getElementById("settingsBtn");
    if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add("hidden");
    }
  });

  // Handle PWA Install
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.classList.remove('hidden'); // tampilkan tombol install
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.classList.add('hidden');
    }
  });

  // Pastikan desa & email tampil
  window.addEventListener("DOMContentLoaded", () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const savedEmail = localStorage.getItem('userEmail') || '';

    if (isLoggedIn && currentUserDesa) {
      const desaEl = document.getElementById("loggedInDesa");
      if (desaEl) desaEl.innerText = currentUserDesa;

      const emailEl = document.getElementById("loggedInEmail");
      if (emailEl) emailEl.innerText = savedEmail;
    }
  });
</script>
<!-- Main Content Area -->
<div class="main-container max-w-4xl w-full bg-white p-2 rounded-xl shadow-lg md:p-4 mx-auto my-0 flex-grow overflow-y-auto hidden" style="margin-top: 60px; margin-bottom: 90px;">
    <!-- Tampilan Daftar Data -->
    <div id="listView" class="p-2 md:p-4">
        <div class="sticky-header bg-white -mt-2 -mx-2 pt-2 pb-2 rounded-t-xl">
            <h1 class="font-bold text-2xl text-center text-blue-800 mb-4">Register Imunisasi TT</h1>
            <div class="mb-4 px-2">
                <input type="text" id="nameNikFilter" placeholder="Cari Nama atau NIK..." class="block w-full p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
        </div>
        <div id="dataList" class="space-y-4">
            <!-- Data will be rendered here -->
            <p class="text-center text-gray-500" id="loadingMessage">Memuat data...</p>
        </div>
        <div id="paginationControls" class="flex justify-center items-center gap-4 mt-4">
            <button id="prevPageBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">Sebelumnya</button>
            <span id="pageInfo" class="text-gray-700">Halaman 1 dari 1</span>
            <button id="nextPageBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">Berikutnya</button>
        </div>
                <button id="fabTambah" 
            class="fixed bottom-14 right-2 bg-orange-500 hover:bg-orange-700 text-white rounded-full w-14 h-14 shadow-lg shadow-green-400/50 flex items-center justify-center transition-transform duration-300 hover:scale-110 hidden">
            <i class="fas fa-plus text-2xl"></i>
        </button>
    </div>

    <!-- Tampilan Formulir Input (Awalnya Tersembunyi) -->
    <div id="formView" class="hidden">
        <div class="sticky-header bg-white -mt-2 -mx-2 pt-2 pb-2 rounded-t-xl">
            <h1 id="formTitle" class="font-bold text-2xl text-center text-blue-800 mb-2">Form Riwayat Imunisasi TT</h1>
        </div>
        <form>
            <section class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">Identitas</h2>
                
                <label for="nama" class="block mb-0 text-gray-700 font-medium">Nama:</label>
                <input type="text" id="nama" required class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                
                <label for="tanggalLahir" class="block mb-0 text-gray-700 font-medium">Tanggal Lahir:</label>
                <input type="date" id="tanggalLahir" onchange="window.hitungUmur(); window.hitungStatusTT(); window.validateTanggalLahir();" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <span id="tanggalLahirError" class="text-red-500 text-xs mt-1"></span>
                
                <label for="umur" class="block mb-0 text-gray-700 font-medium">Umur:</label>
                <input type="text" id="umur" readonly class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 bg-gray-50 cursor-not-allowed">

                <label for="nik" class="block mb-0 text-gray-700 font-medium">NIK:</label>
                <input type="text" id="nik" inputmode="numeric" pattern="[0-9]*" required oninput="window.validateNik()" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <span id="nikError" class="text-red-500 text-xs mt-1"></span>

                <label for="desaKelurahan" class="block mb-0 text-gray-700 font-medium">Desa/Kelurahan:</label>
                <select id="desaKelurahan" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="">Pilih Desa/Kelurahan</option>
                    <option value="Arawa">Arawa</option>
                    <option value="Bangkai">Bangkai</option>
                    <option value="Batu Lappa">Batu Lappa</option>
                    <option value="Buae">Buae</option>
                    <option value="Carawali">Carawali</option>
                    <option value="Ciro-ciroe">Ciro-ciroe</option>
                    <option value="Lainungan">Lainungan</option>
                    <option value="Lawawoi">Lawawoi</option>
                    <option value="Mattirotasi">Mattirotasi</option>
                    <option value="Uluale">Uluale</option>
                    <option value="Luar Wilayah">Luar Wilayah</option>
                </select>

                <label for="alamat" class="block mb-0 text-gray-700 font-medium">Alamat:</label>
                <textarea id="alamat" rows="2" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>

                <label for="noHp" class="block mb-0 text-gray-700 font-medium">No. HP (untuk WhatsApp):</label>
                <input type="text" id="noHp" inputmode="numeric" pattern="[0-9]*" placeholder="Contoh: 081234567890" oninput="window.hitungStatusTT(); window.validateNoHp();" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <span id="noHpError" class="text-red-500 text-xs mt-1"></span>

                <label for="tanggalLayanan" class="block mb-0 text-gray-700 font-medium">Tanggal Layanan:</label>
                <input type="date" id="tanggalLayanan" onchange="window.hitungUmur(); window.hitungStatusTT();" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </section>

            <section id="sectionBayi" class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">1. Saat Bayi/Baduta</h2>
                <label for="bayiStatus" class="block mb-0 text-gray-700 font-medium">Apakah pernah mendapatkan imunisasi TT saat bayi/baduta?</label>
                <select id="bayiStatus" onchange="window.toggleSub('bayiStatus', 'subBayi'); window.hitungStatusTT()" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="Tidak" selected>Tidak</option>
                    <option value="Ya">Ya</option>
                </select>
                <div id="subBayi" class="subsection hidden ml-0 p-5 bg-blue-50 border-l-4 border-blue-300 rounded-lg mt-5">
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="dpt1_checkbox" onchange="window.calculateAndFillDate('dpt1_checkbox', 'dpt1_date', 'month', 3); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="dpt1_checkbox" class="text-gray-700 font-medium flex-grow">DPT1 (Usia 3 bulan):</label>
                        <input type="date" id="dpt1_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="dpt2_checkbox" onchange="window.calculateAndFillDate('dpt2_checkbox', 'dpt2_date', 'month', 4); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="dpt2_checkbox" class="text-gray-700 font-medium flex-grow">DPT2 (Usia 4 bulan):</label>
                        <input type="date" id="dpt2_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="dpt3_checkbox" onchange="window.calculateAndFillDate('dpt3_checkbox', 'dpt3_date', 'month', 5); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="dpt3_checkbox" class="text-gray-700 font-medium flex-grow">DPT3 (Usia 5 bulan):</label>
                        <input type="date" id="dpt3_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="dpt4_checkbox" onchange="window.calculateAndFillDate('dpt4_checkbox', 'dpt4_date', 'month', 18); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="dpt4_checkbox" class="text-gray-700 font-medium flex-grow">DPT4 (Usia 18 bulan):</label>
                        <input type="date" id="dpt4_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                </div>
            </section>

            <section id="sectionSekolah" class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">2. Saat Sekolah (BIAS)</h2>
                <label for="sekolahStatus" class="block mb-0 text-gray-700 font-medium">Apakah pernah mendapatkan imunisasi TT saat sekolah?</label>
                <select id="sekolahStatus" onchange="window.toggleSub('sekolahStatus', 'subSekolah'); window.hitungStatusTT()" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="Tidak" selected>Tidak</option>
                    <option value="Ya">Ya</option>
                </select>
                <div id="subSekolah" class="subsection hidden ml-0 p-5 bg-blue-50 border-l-4 border-blue-300 rounded-lg mt-5">
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="kelas1_checkbox" onchange="window.calculateAndFillDate('kelas1_checkbox', 'kelas1_date', 'year', 7); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="kelas1_checkbox" class="text-gray-700 font-medium flex-grow">Kelas 1 (Usia 7 tahun):</label>
                        <input type="date" id="kelas1_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="kelas2_checkbox" onchange="window.calculateAndFillDate('kelas2_checkbox', 'kelas2_date', 'year', 8); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="kelas2_checkbox" class="text-gray-700 font-medium flex-grow">Kelas 2 (Usia 8 tahun):</label>
                        <input type="date" id="kelas2_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="kelas5_checkbox" onchange="window.calculateAndFillDate('kelas5_checkbox', 'kelas5_date', 'year', 11); window.hitungStatusTT()" class="mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <label for="kelas5_checkbox" class="text-gray-700 font-medium flex-grow">Kelas 5 (Usia 11 tahun):</label>
                        <input type="date" id="kelas5_date" onchange="window.hitungStatusTT()" class="flex-none p-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent w-1/2 md:w-auto">
                    </div>
                </div>
            </section>

            <section id="sectionCatin" class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">3. Saat Calon Pengantin</h2>
                <label for="catin1" class="block mb-0 text-gray-700 font-medium">Imunisasi pertama (tanggal):</label>
                <input type="date" id="catin1" onchange="window.hitungStatusTT()" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                
                <label for="catin2" class="block mb-0 text-gray-700 font-medium">Imunisasi kedua (tanggal):</label>
                <input type="date" id="catin2" onchange="window.hitungStatusTT()" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </section>

            <section id="sectionHamil" class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">4. Saat Hamil</h2>
                <div id="hamilContainer">
                    <div class="hamil-entry mb-1 pb-2 border-b border-dashed border-gray-200 last:border-b-0 last:mb-0 last:pb-0">
                        <label class="block mb-0 text-gray-700 font-medium">Hamil anak ke-1 (tanggal):
                            <input type="date" name="hamil[]" onchange="window.hitungStatusTT()" class="block w-full p-3 mt-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </label>
                    </div>
                </div>
                <button type="button" onclick="window.tambahKehamilan()" class="px-6 py-3 rounded-lg text-white font-medium text-lg cursor-pointer transition-all duration-300 ease-in-out mt-5 shadow-md hover:shadow-lg hover:translate-y-[-2px] bg-green-600 hover:bg-green-700 w-full md:w-auto">
                    + Tambah Kehamilan
                </button>
            </section>

            <!-- START: New "Lainnya" Section -->
            <section id="sectionLainnya" class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">5. Lainnya</h2>
                <div id="lainnyaContainer">
                    <div class="lainnya-entry mb-1 pb-2 border-b border-dashed border-gray-200 last:border-b-0 last:mb-0 last:pb-0">
                        <label class="block mb-0 text-gray-700 font-medium">Tanggal Imunisasi:</label>
                        <input type="date" name="lainnyaDate[]" onchange="window.hitungStatusTT()" class="block w-full p-3 mt-2 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <label class="block mb-0 text-gray-700 font-medium">Keterangan:</label>
                        <textarea name="lainnyaKeterangan[]" rows="1" class="block w-full p-3 mt-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: TT terjadwal, TT atas indikasi"></textarea>
                    </div>
                </div>
                <button type="button" onclick="window.tambahLainnya()" class="px-6 py-3 rounded-lg text-white font-medium text-lg cursor-pointer transition-all duration-300 ease-in-out mt-5 shadow-md hover:shadow-lg hover:translate-y-[-2px] bg-indigo-600 hover:bg-indigo-700 w-full md:w-auto">
                    + Tambah Lainnya
                </button>
            </section>
            <!-- END: New "Lainnya" Section -->

            <!-- New "Catatan" Section -->
            <section class="bg-gray-50 p-6 mb-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="font-semibold text-xl text-gray-700 border-b-2 border-blue-200 pb-3 mt-0 mb-3 md:text-2xl">Catatan Tambahan</h2>
                <label for="catatan" class="block mb-0 text-gray-700 font-medium">Catatan:</label>
                <textarea id="catatan" rows="3" class="block w-full p-3 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2                 focus:ring-green-500 focus:border-transparent"></textarea>
            </section>

        </form>

<div class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-300 shadow-md px-3 py-2 flex items-center justify-between gap-3 max-w-4xl mx-auto">
    
    <!-- Tombol Tutup di kiri -->
    <div>
        <button type="button" id="closeFormBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md">
            Tutup
        </button>
    </div>

    <!-- STATUS OUTPUT di tengah -->
    <div id="statusOutput" class="flex-1 text-center bg-orange-600 text-white px-3 py-1 rounded-lg font-bold shadow-md text-sm md:sm flex flex-col justify-center items-center">
        <!-- Akan diisi oleh JavaScript -->
    </div>

    <!-- Tombol Simpan di kanan -->
    <div>
        <button type="button" id="saveDataButtonForm" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold shadow-md">
            Simpan
        </button>
    </div>
</div>

    </div>

    <!-- Tampilan Laporan (Awalnya Tersembunyi) -->
    <div id="reportView" class="hidden p-2 md:p-4">
        <div class="sticky-header bg-white -mt-2 -mx-2 pt-2 pb-2 rounded-t-xl">
            <h1 class="font-bold text-2xl text-center text-blue-800 mb-1">Laporan Imunisasi TT</h1>

            <!-- START: Dropdown filter bulan dan tahun dalam 1 baris -->
            <div class="flex flex-row flex-wrap gap-4 mb-3 items-center justify-center px-2">
                <div id="monthFilterContainer" class="flex items-center gap-2">
                    <label for="monthFilter" class="text-sm font-medium text-gray-700">Bulan:</label>
                    <select id="monthFilter" class="block p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div id="yearFilterContainer" class="flex items-center gap-2">
                    <label for="yearFilter" class="text-sm font-medium text-gray-700">Tahun:</label>
                    <select id="yearFilter" class="block p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
            <!-- END: Dropdown filter bulan dan tahun dalam 1 baris -->

        <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
            <table id="reportTable" class="min-w-full divide-y divide-gray-200">
                <thead id="reportTableHeader" class="bg-gray-50">
                    <!-- Table headers will be dynamically generated by JS -->
                </thead>
                <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="17" class="text-center py-4 text-gray-500">Pilih bulan dan tahun untuk menampilkan laporan.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
            <!-- NEW: Download Buttons Container -->
<!-- NEW: Download Buttons Container -->
<div class="flex flex-col md:flex-row justify-start items-center gap-4 mt-8 px-2">
  <h3 class="font-semibold text-base text-gray-700 md:mr-4">📥 Download:</h3>

  <button id="downloadRecapReportBtn" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center w-full md:w-auto">
    <i class="fas fa-file-csv mr-2 text-base"></i> Laporan Rekapitulasi
  </button>

  <button id="downloadIndividualReportBtn" class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg font-semibold shadow-md hover:bg-green-700 transition-colors flex items-center justify-center w-full md:w-auto">
    <i class="fas fa-file-alt mr-2 text-base"></i> Laporan Individu
  </button>
</div>

        </div>
</div>

<div id="mainNavBar" class="fixed bottom-0 left-0 right-0 z-10 bg-blue-100 border-t border-gray-200 shadow-md px-2 py-1">
    <div class="flex justify-between items-center max-w-4xl mx-auto w-full gap-2">
        
        <!-- Tombol DATA -->
        <button id="navShowListBtn" 
            class="flex-1 flex flex-row items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-all duration-200">
            <i class="fas fa-list text-lg"></i>
            <span>DATA</span>
        </button>

        <!-- Tombol LAPORAN -->
        <button id="navShowReportBtn" 
            class="flex-1 flex flex-row items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-purple-500 hover:bg-purple-600 rounded-md transition-all duration-200">
            <i class="fas fa-chart-bar text-lg"></i>
            <span>LAPORAN</span>
        </button>
  <!-- Floating Button Tambah (pojok kanan bawah) -->
<button id="navShowFormBtn" class="hidden"></button>
        <!-- END: Tombol menu -->
    </div>
</div>

<!-- Custom Modal for Alerts -->
<div id="customAlertDialog" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Pesan</h3>
        <p id="customAlertMessage" class="text-gray-700 mb-6"></p>
        <div class="flex justify-end">
            <!-- New Edit button, initially hidden -->
            <button id="editFromAlertBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors mr-3 hidden">Edit Data</button>
            <button onclick="window.closeCustomAlert()" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>
</div>

<!-- Full Detail Modal -->
<div id="fullDetailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
        <h3 class="text-2xl font-semibold text-blue-800 mb-4 text-center">Riwayat Imunisasi TT</h3>
        
        <section class="bg-gray-50 p-4 mb-4 rounded-lg shadow-inner border border-gray-200">
            <h4 class="font-semibold text-lg text-gray-700 border-b-2 border-blue-200 pb-2 mb-3">Identitas</h4>
            <p class="text-gray-700"><strong>Nama:</strong> <span id="detailNama" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>Tanggal Lahir:</strong> <span id="detailTanggalLahir" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>Umur:</strong> <span id="detailUmur" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>NIK:</strong> <span id="detailNik" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>Desa/Kelurahan:</strong> <span id="detailDesaKelurahan" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>Alamat:</strong> <span id="detailAlamat" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>No. HP:</strong> <span id="detailNoHp" class="font-medium"></span></p>
            <p class="text-gray-700"><strong>Tanggal Layanan:</strong> <span id="detailTanggalLayanan" class="font-medium"></span></p>
        </section>

        <section class="bg-gray-50 p-4 mb-4 rounded-lg shadow-inner border border-gray-200">
            <h4 class="font-semibold text-lg text-gray-700 border-b-2 border-blue-200 pb-2 mb-3">Status Imunisasi TT</h4>
                    
            <h5 class="font-semibold text-base text-gray-700 mb-2">Riwayat Dosis TT Diberikan:</h5>
            <ul id="detailDosesList" class="list-disc list-inside text-gray-700 space-y-1">
                <!-- Doses will be listed here -->
            </ul>
            <p class="text-base font-semibold text-blue-800 mt-4">Status TT Terakhir: <span id="detailStatusTt" class="font-medium"></span></p>
            <p class="text-base text-blue-800 mb-2">Jadwal TT Berikutnya: <span id="detailJadwalDosisBerikutnya" class="font-medium"></span></p>

        </section>

        <section class="bg-gray-50 p-4 mb-6 rounded-lg shadow-inner border border-gray-200">
            <h4 class="font-semibold text-lg text-gray-700 border-b-2 border-blue-200 pb-2 mb-3">Catatan Tambahan</h4>
            <p id="detailCatatan" class="text-gray-700 whitespace-pre-wrap">Tidak ada catatan.</p>
    <!-- Tambahan email penginput -->
    <p class="text-gray-700 mt-2">
      <strong>Email Penginput:</strong> <span id="detailUserEmail" class="font-medium"></span>
    </p>
        </section>

    </div>
<div class="fixed bottom-0 left-0 right-0 z-40 bg-white shadow-md border-t border-gray-300 px-4 py-3 flex justify-between max-w-2xl mx-auto">
    <!-- Tombol kiri: Hapus -->
    <div>
        <button id="deleteFromFullModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">Hapus</button>
    </div>

    <!-- Tombol kanan: Edit dan Tutup -->
    <div class="flex gap-3">
        <button id="editFromFullModalBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Edit</button>
        <button onclick="window.closeFullDetailModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md">Tutup</button>
    </div>
</div>


</div>

<!-- Custom Confirmation Modal for Delete -->
<div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Konfirmasi Penghapusan</h3>
        <p id="confirmationMessage" class="text-gray-700 mb-6">Apakah Anda yakin ingin menghapus data ini secara permanen?</p>
        <div class="flex justify-end gap-3">
            <button id="confirmDeleteBtn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Hapus</button>
            <button onclick="window.closeConfirmationModal()" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Batal</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p class="text-blue-700 text-lg font-semibold">Memuat data...</p>
</div>

<!-- Download Report Modal -->
<div id="downloadReportModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Unduh Laporan Imunisasi TT</h3>
        <p class="text-gray-700 mb-4">Pilih bulan dan tahun untuk laporan yang akan diunduh:</p>
        
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex items-center gap-2">
                <label for="downloadMonthFilter" class="text-sm font-medium text-gray-700">Bulan:</label>
                <select id="downloadMonthFilter" class="block p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 flex-grow">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label for="downloadYearFilter" class="text-sm font-medium text-gray-700">Tahun:</label>
                <select id="downloadYearFilter" class="block p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 flex-grow">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
        </div>

        <div class="flex justify-end gap-3">
            <button id="confirmDownloadBtn" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                <i class="fas fa-download mr-2"></i> Unduh
            </button>
            <button onclick="window.closeDownloadReportModal()" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Batal</button>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    // 1. Ganti Import Firebase yang Sesuai untuk Firestore
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        enableIndexedDbPersistence,
        doc, // Untuk operasi dokumen spesifik (update, delete)
        updateDoc, // Untuk update dokumen
        deleteDoc // Untuk delete dokumen
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "AIzaSyCN2Whqu5zGG1s0h5ZIb0kUlonPbISzuAg",
      authDomain: "sitta-c02cf.firebaseapp.com",
      projectId: "sitta-c02cf",
      storageBucket: "sitta-c02cf.firebasestorage.app",
      messagingSenderId: "992999217761",
      appId: "1:992999217761:web:b457ef93ff2b3b7613e820"
    };

    // 2. Inisialisasi Firebase & Firestore
    // Inisialisasi Firebase App
    const app = initializeApp(firebaseConfig);
    // Inisialisasi Firestore
    const db = getFirestore(app);

    // Aktifkan penyimpanan offline Firestore
    enableIndexedDbPersistence(db).then(() => {
        console.log("✅ Offline persistence aktif di Firestore");
    }).catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn("Persistence tidak dapat diaktifkan: beberapa tab terbuka.");
        } else if (err.code == 'unimplemented') {
            console.warn("Persistence tidak didukung di browser ini.");
        } else {
            console.error("❌ Gagal mengaktifkan offline persistence:", err);
        }
    });

    let currentUserDesa = localStorage.getItem('userDesa') || null;
    let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; // New flag for offline login

// Kode BARU untuk mengambil email
const userEmail = localStorage.getItem('userEmail');
const loggedInEmailSpan = document.getElementById('loggedInEmail');

// Jika email ditemukan, tampilkan di elemen yang baru dibuat
if (loggedInEmailSpan && userEmail) {
  loggedInEmailSpan.textContent = `(${userEmail})`;
}

    // Fungsi untuk mengelola tampilan UI utama aplikasi (main content area dan login modal)
    // Semua fungsi yang dipanggil dari atribut HTML perlu dilampirkan ke objek `window`.
    window.setAppUI = function(showMainContent) {
        const mainContainer = document.querySelector('.main-container');
        const loginModal = document.getElementById('loginModal');

        if (showMainContent) {
            mainContainer.classList.remove('hidden');
            loginModal.classList.add('hidden');
        } else {
            mainContainer.classList.add('hidden');
            loginModal.classList.remove('hidden');
        }
    }

    // Fungsi untuk menerapkan ukuran font yang disimpan atau default
    window.applyFontSize = function() {
        const baseSize = 16 + (currentZoomLevel * 2); 
        document.documentElement.style.setProperty('--base-font-size', `${baseSize}px`);
        window.updateFontSizeControls();
    }

window.addEventListener('DOMContentLoaded', () => {
    console.log("[DOMContentLoaded] Fired.");
    console.log("[DOMContentLoaded] Initial currentUserDesa from localStorage:", localStorage.getItem('userDesa'));
    console.log("[DOMContentLoaded] Initial isLoggedIn from localStorage:", localStorage.getItem('isLoggedIn'));
    console.log("[DOMContentLoaded] Parsed isLoggedIn variable:", isLoggedIn);

    window.applyFontSize(); 
    window.updateNetworkStatus(); 

    if (isLoggedIn && currentUserDesa) {
        console.log("[DOMContentLoaded] Offline login successful. Showing main content.");
        window.setAppUI(true);
        window.showView('listView'); 
        document.getElementById('loggedInDesa').innerText = currentUserDesa;

        // >>> tambahan untuk tampilkan email di header
        const savedEmail = localStorage.getItem('userEmail') || '';
        const emailEl = document.getElementById('loggedInEmail');
        if (emailEl) emailEl.innerText = savedEmail;
        // <<< selesai tambahan
    } else {
        console.log("[DOMContentLoaded] Offline login failed. Showing login modal.");
        window.setAppUI(false);
    }
});

    // --- START: Hardcoded User Credentials ---
    const users = [
        { desaKelurahan: "Arawa", password: "userarawa" },
        { desaKelurahan: "Bangkai", password: "userbangkai" },
        { desaKelurahan: "Batu Lappa", password: "userbatulappa" },
        { desaKelurahan: "Buae", password: "userbuae" },
        { desaKelurahan: "Carawali", password: "usercarawali" },
        { desaKelurahan: "Ciro-ciroe", password: "usercirociroe" },
        { desaKelurahan: "Lainungan", password: "userlainungan" },
        { desaKelurahan: "Lawawoi", password: "userlawawoi" },
        { desaKelurahan: "Mattirotasi", password: "usermattirotasi" },
        { desaKelurahan: "Uluale", password: "useruluale" },
        { desaKelurahan: "Luar Wilayah", password: "userluarwilayah" },
    ];
    const ADMIN_DESA = "AdminPuskesmas";
    const ADMIN_PASSWORD = "adminpassword123";
    // --- END: Hardcoded User Credentials ---

    window.handleLogin = async function() {
        const desa = document.getElementById('loginDesa').value.trim();
        const pass = document.getElementById('loginPassword').value.trim();
        const loginErrorMessage = document.getElementById('loginErrorMessage');

        loginErrorMessage.classList.add('hidden');
        loginErrorMessage.innerText = '';

        if (!desa || !pass) {
            loginErrorMessage.innerText = 'Mohon isi semua kolom.';
            loginErrorMessage.classList.remove('hidden');
            return;
        }

        window.showLoading();

        if (desa === ADMIN_DESA && pass === ADMIN_PASSWORD) {
            currentUserDesa = ADMIN_DESA;
            localStorage.setItem('userDesa', ADMIN_DESA);
            localStorage.setItem('isLoggedIn', 'true');
            isLoggedIn = true;
            document.getElementById('loggedInDesa').innerText = currentUserDesa;
            window.setAppUI(true);
            window.hideLoading();
            window.loadAndRenderData();
            window.populateFilters();
            window.showView('listView');
            return;
        }

        const matchedUser = users.find(user => user.desaKelurahan === desa && user.password === pass);

        if (matchedUser) {
            currentUserDesa = matchedUser.desaKelurahan;
            localStorage.setItem('userDesa', matchedUser.desaKelurahan);
            localStorage.setItem('isLoggedIn', 'true');
            isLoggedIn = true;
            document.getElementById('loggedInDesa').innerText = currentUserDesa;
            window.setAppUI(true);
            window.hideLoading();
            window.loadAndRenderData();
            window.populateFilters();
            window.showView('listView');
        } else {
            loginErrorMessage.innerText = 'Login gagal. Periksa desa dan password Anda.';
            loginErrorMessage.classList.remove('hidden');
            window.hideLoading();
        }
    }

    window.handleLogout = function() {
        localStorage.removeItem('userDesa');
        localStorage.removeItem('isLoggedIn');
        currentUserDesa = null;
        isLoggedIn = false;
        document.getElementById('loggedInDesa').innerText = '';
        window.setAppUI(false);
        window.resetForm();
        window.updateNetworkStatus();
    }

    let allImunisasiData = [];
    let currentEditingItemUniqueId = null;
    let currentScrollPosition = 0;
    let currentView = 'list';
    let currentZoomLevel = parseInt(localStorage.getItem('fontSizeZoomLevel') || '0');
    const optionsLong = { day: '2-digit', month: 'long', year: 'numeric' };
    const optionsShort = { day: '2-digit', month: 'short', year: 'numeric' };
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredData = [];

    window.sanitizeCsvField = function(field) {
        if (field === null || field === undefined) {
            return '';
        }
        let stringField = String(field);
        stringField = stringField.replace(/"/g, '""');
        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return `"${stringField}"`;
        }
        return stringField;
    }

    window.showLoading = function() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    window.hideLoading = function() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    window.adjustFontSize = function(change) {
        if (change === 0) {
            currentZoomLevel = 0;
        } else {
            currentZoomLevel += change;
            if (currentZoomLevel < -2) currentZoomLevel = -2;
            if (currentZoomLevel > 2) currentZoomLevel = 2;
        }
        const baseSize = 16 + (currentZoomLevel * 2); 
        document.documentElement.style.setProperty('--base-font-size', `${baseSize}px`);
        window.updateFontSizeControls();
    }

    window.updateFontSizeControls = function() {
        document.getElementById('zoomOutBtn').disabled = (currentZoomLevel === -2);
        document.getElementById('resetZoomBtn').disabled = (currentZoomLevel === 0);
        document.getElementById('zoomInBtn').disabled = (currentZoomLevel === 2);
    }

    window.showCustomAlert = function(message, whatsappLink = null, itemUniqueId = null) {
        const customAlertDialog = document.getElementById('customAlertDialog');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const alertButtonsContainer = customAlertDialog.querySelector('.flex.justify-end');
        const editButton = document.getElementById('editFromAlertBtn');

        customAlertMessage.innerText = message;

        let whatsappAlertButton = document.getElementById('whatsappAlertButton');
        if (whatsappAlertButton) {
            whatsappAlertButton.remove();
        }

        if (whatsappLink) {
            whatsappAlertButton = document.createElement('button');
            whatsappAlertButton.id = 'whatsappAlertButton';
            whatsappAlertButton.className = 'px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors mr-3';
            whatsappAlertButton.innerText = 'Bagikan ke WhatsApp';
            whatsappAlertButton.onclick = () => {
                window.open(whatsappLink, '_blank');
                window.closeCustomAlert();
            };
            alertButtonsContainer.prepend(whatsappAlertButton);
        }

        if (itemUniqueId) {
            editButton.classList.remove('hidden');
            editButton.onclick = () => {
                window.editDataFromAlert(itemUniqueId);
            };
        } else {
            editButton.classList.add('hidden');
        }

        customAlertDialog.classList.remove('hidden');
    }

    window.closeCustomAlert = function() {
        document.getElementById('customAlertDialog').classList.add('hidden');
        let whatsappAlertButton = document.getElementById('whatsappAlertButton');
        if (whatsappAlertButton) {
            whatsappAlertButton.remove();
        }
        document.getElementById('editFromAlertBtn').classList.add('hidden');
    }

    window.showConfirmationModal = function(message, onConfirm) {
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        confirmationMessage.innerText = message;
        confirmDeleteBtn.onclick = onConfirm;

        confirmationModal.classList.remove('hidden');
    }

    window.closeConfirmationModal = function() {
        document.getElementById('confirmationModal').classList.add('hidden');
    }

    window.formatDateToYYYYMMDD = function(dateString) {
        if (!dateString) return '';
        const d = new Date(dateString);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    window.toggleSub = function(statusId, subId) {
        const selected = document.getElementById(statusId).value;
        const sub = document.getElementById(subId);
        
        if (selected === 'Ya') {
            sub.classList.remove('hidden');
        } else {
            sub.classList.add('hidden');
            sub.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            sub.querySelectorAll('input[type="date"]').forEach(dateInput => {
                dateInput.value = "";
            });
        }
        window.hitungStatusTT();
    }

    window.tambahKehamilan = function() {
        const container = document.getElementById("hamilContainer");
        const count = container.getElementsByClassName("hamil-entry").length + 1;
        const div = document.createElement("div");
        div.className = "hamil-entry mb-1 pb-2 border-b border-dashed border-gray-200 last:border-b-0 last:mb-0 last:pb-0";
        div.innerHTML = `
            <label class="block mb-0 text-gray-700 font-medium">Hamil anak ke-${count} (tanggal):
                <input type="date" name="hamil[]" onchange="window.hitungStatusTT()" class="block w-full p-3 mt-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </label>
        `;
        container.appendChild(div);
    }

    window.tambahLainnya = function() {
        const container = document.getElementById("lainnyaContainer");
        const div = document.createElement("div");
        div.className = "lainnya-entry mb-1 pb-2 border-b border-dashed border-gray-200 last:border-b-0 last:mb-0 last:pb-0";
        div.innerHTML = `
            <label class="block mb-0 text-gray-700 font-medium">Tanggal Imunisasi:</label>
            <input type="date" name="lainnyaDate[]" onchange="window.hitungStatusTT()" class="block w-full p-3 mt-2 mb-1 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <label class="block mb-0 text-gray-700 font-medium">Keterangan:</label>
            <textarea name="lainnyaKeterangan[]" rows="1" class="block w-full p-3 mt-2 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: TT terjadwal, TT atas indikasi"></textarea>
        `;
        container.appendChild(div);
    }

    window.hitungUmur = function() {
        const tanggalLahirInput = document.getElementById("tanggalLahir").value;
        const tanggalLayananInput = document.getElementById("tanggalLayanan").value;
        const umurOutput = document.getElementById("umur");

        if (tanggalLahirInput && tanggalLayananInput) {
            const birthDate = new Date(tanggalLahirInput);
            const serviceDate = new Date(tanggalLayananInput);

            let years = serviceDate.getFullYear() - birthDate.getFullYear();
            let months = serviceDate.getMonth() - birthDate.getMonth();
            let days = serviceDate.getDate() - birthDate.getDate();

            if (days < 0) {
                months--;
                days += new Date(serviceDate.getFullYear(), serviceDate.getMonth(), 0).getDate();
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            umurOutput.value = `${years} tahun ${months} bulan`;
        } else {
            umurOutput.value = "";
        }
    }

    window.calculateAndFillDate = function(checkboxId, dateInputId, type, offset) {
        const checkbox = document.getElementById(checkboxId);
        const dateInput = document.getElementById(dateInputId);
        const tanggalLahirInput = document.getElementById("tanggalLahir").value;

        if (!tanggalLahirInput) {
            window.showCustomAlert("Harap isi Tanggal Lahir terlebih dahulu.");
            checkbox.checked = false;
            dateInput.value = "";
            return;
        }

        if (checkbox.checked) {
            const birthDate = new Date(tanggalLahirInput);
            let calculatedDate = new Date(birthDate);

            if (type === 'month') {
                calculatedDate.setMonth(calculatedDate.getMonth() + offset);
            } else if (type === 'year') {
                calculatedDate.setFullYear(calculatedDate.getFullYear() + offset);
            }

            dateInput.value = window.formatDateToYYYYMMDD(calculatedDate);
        } else {
            dateInput.value = "";
        }
        window.hitungStatusTT();
    }

    window.setError = function(inputId, errorId, message) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(errorId);
        if (message) {
            inputElement.classList.add('input-error');
            errorElement.innerText = message;
        } else {
            inputElement.classList.remove('input-error');
            errorElement.innerText = '';
        }
    }

    window.validateNik = function() {
        const nikInput = document.getElementById('nik');
        const nik = nikInput.value.trim();
        if (nik.length === 0) {
            window.setError('nik', 'nikError', 'NIK tidak boleh kosong.');
            return false;
        }
        if (!/^\d{16}$/.test(nik)) {
            window.setError('nik', 'nikError', 'NIK harus 16 digit angka.');
            return false;
        }
        window.setError('nik', 'nikError', '');
        return true;
    }

    window.validateNoHp = function() {
        const noHpInput = document.getElementById('noHp');
        const noHp = noHpInput.value.trim();
        if (noHp.length === 0) {
            window.setError('noHp', 'noHpError', 'Nomor HP tidak boleh kosong.');
            return false;
        }
        if (!/^08\d{8,11}$/.test(noHp)) {
            window.setError('noHp', 'noHpError', 'Nomor HP tidak valid (contoh: 081234567890).');
            return false;
        }
        window.setError('noHp', 'noHpError', '');
        return true;
    }

    window.validateTanggalLahir = function() {
        const tanggalLahirInput = document.getElementById('tanggalLahir');
        const tanggalLahir = tanggalLahirInput.value;
        if (!tanggalLahir) {
            window.setError('tanggalLahir', 'tanggalLahirError', 'Tanggal Lahir tidak boleh kosong.');
            return false;
        }
        const birthDate = new Date(tanggalLahir);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (birthDate > today) {
            window.setError('tanggalLahir', 'tanggalLahirError', 'Tanggal Lahir tidak boleh di masa depan.');
            return false;
        }
        window.setError('tanggalLahir', 'tanggalLahirError', '');
        return true;
    }

    window.hitungStatusTT = function() {
        const output = document.getElementById("statusOutput");
                
        const nik = document.getElementById("nik").value.trim();
        const nama = document.getElementById("nama").value.trim();
        const desaKelurahan = document.getElementById("desaKelurahan").value.trim();
        const alamat = document.getElementById("alamat").value.trim();
        const noHp = document.getElementById("noHp").value.trim();
        const tanggalLahirInput = document.getElementById("tanggalLahir").value.trim();
        const umur = document.getElementById("umur").value.trim();
        const tanggalLayananStr = document.getElementById("tanggalLayanan").value.trim();
        const catatan = document.getElementById("catatan").value.trim();

        let formattedTanggalLahir = "belum diisi";
        let formattedTanggalLayanan = "belum diisi";

        if (tanggalLayananStr) {
            formattedTanggalLayanan = new Date(tanggalLayananStr).toLocaleDateString("id-ID", optionsLong);
        }

        let birthDate = null;
        if (tanggalLahirInput) {
            birthDate = new Date(tanggalLahirInput);
            formattedTanggalLahir = birthDate.toLocaleDateString("id-ID", optionsLong);
        }

        const bayiOn = document.getElementById("bayiStatus").value === "Ya";
        const sekolahOn = document.getElementById("sekolahStatus").value === "Ya";

        const childhoodDoses = [];
        if (bayiOn) {
            if (document.getElementById("dpt1_date").value) childhoodDoses.push({ date: new Date(document.getElementById("dpt1_date").value), source: 'DPT1 (Bayi)' });
            if (document.getElementById("dpt2_date").value) childhoodDoses.push({ date: new Date(document.getElementById("dpt2_date").value), source: 'DPT2 (Bayi)' });
            if (document.getElementById("dpt3_date").value) childhoodDoses.push({ date: new Date(document.getElementById("dpt3_date").value), source: 'DPT3 (Bayi)' });
            if (document.getElementById("dpt4_date").value) childhoodDoses.push({ date: new Date(document.getElementById("dpt4_date").value), source: 'DPT4 (Bayi)' });
        }
        if (sekolahOn) {
            if (document.getElementById("kelas1_date").value) childhoodDoses.push({ date: new Date(document.getElementById("kelas1_date").value), source: 'Kelas 1 (Sekolah)' });
            if (document.getElementById("kelas2_date").value) childhoodDoses.push({ date: new Date(document.getElementById("kelas2_date").value), source: 'Kelas 2 (Sekolah)' });
            if (document.getElementById("kelas5_date").value) childhoodDoses.push({ date: new Date(document.getElementById("kelas5_date").value), source: 'Kelas 5 (Sekolah)' });
        }

        const otherDoses = [];
        if (document.getElementById("catin1").value) otherDoses.push({ date: new Date(document.getElementById("catin1").value), source: 'Catin 1' });
        if (document.getElementById("catin2").value) otherDoses.push({ date: new Date(document.getElementById("catin2").value), source: 'Catin 2' });

        const kehamilanInputs = document.querySelectorAll('input[name="hamil[]"]');
        kehamilanInputs.forEach((input, index) => {
            if (input.value) otherDoses.push({ date: new Date(input.value), source: `Hamil anak ke-${index + 1}` });
        });

        const lainnyaDates = document.querySelectorAll('input[name="lainnyaDate[]"]');
        const lainnyaKeterangan = document.querySelectorAll('textarea[name="lainnyaKeterangan[]"]');
        lainnyaDates.forEach((dateInput, index) => {
            if (dateInput.value) {
                const keterangan = lainnyaKeterangan[index] ? lainnyaKeterangan[index].value.trim() : '';
                otherDoses.push({ date: new Date(dateInput.value), source: `Lainnya (${keterangan || 'Tanpa Keterangan'})` });
            }
        });

        const allDoses = [...childhoodDoses, ...otherDoses].sort((a, b) => a.date - b.date);

        const validDoses = [];
        const tlVisits = [];

        for (let i = 0; i < allDoses.length; i++) {
            const currentDose = allDoses[i];
            let prevDoseDate = null;

            if (validDoses.length > 0) {
                prevDoseDate = validDoses[validDoses.length - 1].date;
            }

            const statusSekarang = validDoses.length + 1;
            let minimalInterval = 0;

            if (statusSekarang === 2) {
                minimalInterval = 30;
            } else if (statusSekarang === 3) {
                minimalInterval = 180;
            } else if (statusSekarang === 4 || statusSekarang === 5) {
                minimalInterval = 365;
            }

            const jarakHari = prevDoseDate ? Math.floor((currentDose.date - prevDoseDate) / (1000 * 60 * 60 * 24)) : 0;

            if (currentDose.date.toString() !== 'Invalid Date') {
                if (validDoses.length < 5) {
                    if (validDoses.length === 0 || jarakHari >= minimalInterval) {
                        validDoses.push(currentDose);
                    } else {
                        console.warn(`[hitungStatusTT] Dosis tidak valid untuk T${statusSekarang} karena interval tidak terpenuhi:`, currentDose);
                    }
                } else {
                    let tlSource = currentDose.source;
                    if (tlSource.startsWith('Hamil anak ke-')) {
                        tlSource = `TL (${tlSource})`;
                    } else if (tlSource.startsWith('Lainnya')) {
                        tlSource = `TL (${tlSource})`;
                    } else if (tlSource.startsWith('Catin')) {
                        tlSource = `TL (${tlSource})`;
                    } else {
                        tlSource = `TL (Kunjungan Ulang)`;
                    }
                    tlVisits.push({ date: currentDose.date, source: tlSource });
                }
            }
        }
        
        console.log("[hitungStatusTT] Valid T1-T5 Doses:", validDoses);
        console.log("[hitungStatusTT] TL Visits:", tlVisits);

        let statusT = validDoses.length;
        let displayStatusTt = `T${statusT}`;
        let nextDoseScheduleForDisplay = "";
        let nextDoseScheduleForStorage = "";

        const isCurrentVisitTL = tlVisits.some(visit => 
            window.formatDateToYYYYMMDD(visit.date) === tanggalLayananStr
        );

        if (statusT === 0) {
            const nextDoseDate = new Date();
            nextDoseScheduleForDisplay = nextDoseDate.toLocaleDateString("id-ID", optionsShort);
            nextDoseScheduleForStorage = nextDoseDate.toISOString().split('T')[0];
            output.innerHTML = `<span>Status: T0</span><span>Jadwal: ${nextDoseScheduleForDisplay}</span>`;
        } else {
            if (statusT === 5 && isCurrentVisitTL) {
                displayStatusTt = "TL";
                nextDoseScheduleForDisplay = "Lengkap (TL)";
                nextDoseScheduleForStorage = "Imunisasi TT lengkap (TL)";
                output.innerHTML = `<span>Status: TL</span><span>Jadwal: ${nextDoseScheduleForDisplay}</span>`;
            } else {
                if (statusT < 5) {
                    const terakhir = validDoses[validDoses.length - 1].date;
                    const next = new Date(terakhir);

                    if (statusT === 1) next.setMonth(next.getMonth() + 1);
                    else if (statusT === 2) next.setMonth(next.getMonth() + 6);
                    else next.setFullYear(next.getFullYear() + 1);
                    
                    nextDoseScheduleForDisplay = next.toLocaleDateString("id-ID", optionsShort);
                    nextDoseScheduleForStorage = next.toISOString().split('T')[0];
                    output.innerHTML = `<span>Status: T${statusT}</span><span>Jadwal: ${nextDoseScheduleForDisplay}</span>`;
                } else {
                    nextDoseScheduleForDisplay = "Lengkap (T5)";
                    nextDoseScheduleForStorage = "Imunisasi TT lengkap (T5)";
                    output.innerHTML = `<span>Status: T5</span><span>Jadwal: ${nextDoseScheduleForDisplay}</span>`;
                }
            }
        }

        const allDosesForStorage = [...validDoses, ...tlVisits].sort((a, b) => a.date - b.date);

       let dataToSave = {
    nik: String(nik).trim(),
    nama: nama,
    desaKelurahan: desaKelurahan,
    alamat: alamat,
    noHp: String(noHp).trim(),
    tanggalLahir: tanggalLahirInput,
    umur: umur,
    tanggalLayanan: tanggalLayananStr,
    statusTt: displayStatusTt,
    jadwalDosisBerikutnya: nextDoseScheduleForStorage,
    ttDosesDetails: allDosesForStorage.map(d => ({
        date: d.date.toISOString().split('T')[0],
        source: d.source
    })),
    catatan: catatan,
    timestamp: new Date().toISOString(),
userEmail: localStorage.getItem('userEmail') || ''
};


        window.currentFormData = dataToSave;

        let messageParts = [];
        const puskesmasName = "*Puskesmas Lawawoi*";

        if (!nama && !alamat && !tanggalLahirInput && !noHp && validDoses.length === 0 && tlVisits.length === 0) {
            messageParts.push("Halo! 👋");
            messageParts.push("Terima kasih telah menggunakan layanan skrining imunisasi TT Puskesmas Lawawoi.");
            messageParts.push("Saat ini, data Anda masih kosong.");
            messageParts.push(`- *Status TT* Anda adalah *T0* ✨`);
            messageParts.push(`- *Jadwal imunisasi berikutnya* adalah *Hari ini*. 🗓️`);
            messageParts.push("_Sayangi diri dan buah hati dengan imunisasi lengkap._");
            messageParts.push("Terima kasih atas kunjungannya. 😊");
            messageParts.push(puskesmasName);
        } else {
            messageParts.push(`Halo Ibu *${nama || '-'}*! 👋`);
            messageParts.push(`NIK: *${nik || '-'}*`);
            messageParts.push(`Tanggal lahir: *${formattedTanggalLahir}*`);
            messageParts.push(`Umur: *${umur || '-'}*`);
            messageParts.push(`Desa/Kelurahan: *${desaKelurahan || '-'}*`);
            messageParts.push(`Alamat: *${alamat || '-'}*`);
            messageParts.push(`\nTerima kasih telah menggunakan layanan skrining imunisasi TT Puskesmas Lawawoi *tanggal ${formattedTanggalLayanan}*:`);

            if (displayStatusTt === "TL") {
                messageParts.push(`- *Status imunisasi TT* Anda sudah *lengkap (TL)*. 🎉`);
            } else if (statusT < 5) {
                messageParts.push(`- *Status TT* saat ini adalah *T${statusT}* ✨`);
                messageParts.push(`- *Jadwal imunisasi berikutnya* adalah *${nextDoseScheduleForDisplay}* 🗓️`);
            } else {
                messageParts.push(`- *Status imunisasi TT* Anda sudah *lengkap (T5)*. 🎉`);
            }
            
            messageParts.push("\n_Sayangi diri dan buah hati dengan imunisasi lengkap._");
            if (catatan) {
                messageParts.push(`*Catatan:* ${catatan}`);
            }
            messageParts.push("\nTerima kasih atas kunjungannya. 😊");
            messageParts.push(puskesmasName);
        }

        const message = messageParts.join("\n");

        if (noHp) {
            let whatsappLink = `https://wa.me/`;
            let formattedNoHp = noHp.replace(/\D/g, '');
            if (formattedNoHp.startsWith('0')) {
                formattedNoHp = '62' + formattedNoHp.substring(1);
            } else if (!formattedNoHp.startsWith('62')) {
                formattedNoHp = '62' + formattedNoHp;
            }
            whatsappLink += formattedNoHp;
            whatsappLink += `?text=${encodeURIComponent(message)}`;
            window.generatedWhatsappLink = whatsappLink;
        } else {
            window.generatedWhatsappLink = null;
        }
    }

    // 3. Buat Fungsi Menyimpan Data ke Firestore
    async function simpanKeFirestore(data, uniqueId = null) {
        try {
            if (uniqueId) {
                // Perbarui dokumen yang sudah ada
                await updateDoc(doc(db, "imunisasi", uniqueId), data);
                console.log("✅ Data berhasil diperbarui di Firestore:", uniqueId);
            } else {
                // Tambahkan dokumen baru
                const docRef = await addDoc(collection(db, "imunisasi"), data);
                console.log("✅ Data berhasil disimpan ke Firestore dengan ID:", docRef.id);
                return docRef.id; // Mengembalikan ID dokumen baru
            }
        } catch (e) {
            console.error("❌ Gagal menyimpan ke Firestore:", e);
            throw e; // Lemparkan error agar bisa ditangkap oleh pemanggil
        }
    }

    // 4. Tambahkan Fungsi untuk Simpan Sementara ke localStorage
    window.simpanKeLocalStorage = function(data) {
        let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
        offlineData.push(data);
        localStorage.setItem("offlineData", JSON.stringify(offlineData));
        console.log("📦 Data disimpan sementara ke localStorage");
    }

    // Fungsi utama untuk menyimpan data (menggantikan saveToFirebase)
    window.saveData = async function() {
        const isNikValid = window.validateNik();
        const isNoHpValid = window.validateNoHp();
        const isTanggalLahirValid = window.validateTanggalLahir();

        const nama = document.getElementById('nama').value.trim();
        const desaKelurahan = document.getElementById('desaKelurahan').value.trim();

        let allRequiredFieldsValid = true;
        if (!nama) {
            window.showCustomAlert("Nama tidak boleh kosong.");
            allRequiredFieldsValid = false;
        }
        if (!desaKelurahan) {
            window.showCustomAlert("Desa/Kelurahan tidak boleh kosong.");
            allRequiredFieldsValid = false;
        }

        if (!isNikValid || !isNoHpValid || !isTanggalLahirValid || !allRequiredFieldsValid) {
            window.showCustomAlert("Mohon perbaiki kesalahan input pada formulir.");
            return;
        }

               const data = window.currentFormData; // Ambil data yang sudah disiapkan

        const currentUserEmail = localStorage.getItem('userEmail');
        data.inisial_pengirim = currentUserEmail;
        window.showLoading();

        try {
            if (navigator.onLine) {
                await simpanKeFirestore(data, currentEditingItemUniqueId);
                window.showCustomAlert("Data berhasil disimpan/diperbarui!", window.generatedWhatsappLink);
            } else {
                window.simpanKeLocalStorage({ ...data, uniqueId: currentEditingItemUniqueId }); // Sertakan uniqueId jika sedang edit
                window.showCustomAlert("Anda sedang offline. Data disimpan sementara & akan disinkronkan nanti.");
            }
            window.resetForm();
            window.showView('listView');
        } catch (error) {
            console.error("Error dalam operasi simpan:", error);
            window.showCustomAlert("Gagal menyimpan data. Mohon coba lagi.");
        } finally {
            window.hideLoading();
            window.loadAndRenderData();
        }
    }

    // 5. Buat Fungsi Sinkronisasi Offline → Online
    window.addEventListener("online", async () => {
        console.log('Koneksi internet pulih! Mencoba sinkronisasi data offline...');
        await window.syncOfflineDataToFirestore();
        window.loadAndRenderData(); // Muat ulang daftar setelah online
        window.updateNetworkStatus(); // Perbarui status jaringan menjadi online
    });

    window.syncOfflineDataToFirestore = async function() {
        let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
        if (offlineData.length === 0) {
            console.log("Tidak ada data offline untuk disinkronkan.");
            return;
        }

        window.showLoading();
        console.log(`Mulai sinkronisasi ${offlineData.length} data offline.`);
        
        const remainingOfflineData = [];
        for (const data of offlineData) {
            try {
                // Jika data memiliki uniqueId, itu berarti pembaruan. Jika tidak, itu adalah penambahan baru.
                if (data.uniqueId) {
                    await simpanKeFirestore(data, data.uniqueId);
                    console.log(`Sinkronisasi update data dengan ID: ${data.uniqueId} berhasil.`);
                } else {
                    await simpanKeFirestore(data); // Tambah data baru
                    console.log(`Sinkronisasi tambah data baru berhasil.`);
                }
            } catch (e) {
                console.error("Gagal sinkronisasi data offline:", data, e);
                remainingOfflineData.push(data); // Simpan data yang gagal untuk coba lagi nanti
            }
        }
        
        if (remainingOfflineData.length > 0) {
            localStorage.setItem("offlineData", JSON.stringify(remainingOfflineData));
            window.showCustomAlert(`Sinkronisasi selesai. ${remainingOfflineData.length} data gagal disinkronkan.`);
        } else {
            localStorage.removeItem("offlineData");
            window.showCustomAlert("Semua data offline telah disinkronkan ke Firestore! 🎉");
        }
        window.hideLoading();
    }


    // Fungsi untuk mengambil data dari Firestore (untuk daftar dan laporan)
    window.fetchDataFromFirebase = async function() {
        window.showLoading();
        try {
            const querySnapshot = await getDocs(collection(db, "imunisasi"));
            const processedData = [];
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                // Firestore Timestamp objects need to be converted to ISO strings if you want to use them directly like dates
                if (data.timestamp && data.timestamp.toDate) {
                    data.timestamp = data.timestamp.toDate().toISOString();
                }
                // Ensure ttDosesDetails is an array, not a string (Firestore should handle this naturally, but good check)
                if (typeof data.ttDosesDetails === 'string') {
                    try {
                        data.ttDosesDetails = JSON.parse(data.ttDosesDetails);
                    } catch (e) {
                        console.error("Failed to parse ttDosesDetails string from Firestore:", data.ttDosesDetails, e);
                        data.ttDosesDetails = [];
                    }
                } else if (!Array.isArray(data.ttDosesDetails)) {
                    data.ttDosesDetails = [];
                }
                processedData.push({ ...data, uniqueId: doc.id }); // Use doc.id as uniqueId
            });
            console.log('[fetchDataFromFirebase] Data dari Firestore:', processedData);
            return processedData;
        } catch (error) {
            console.error('[fetchDataFromFirebase] Error fetching data from Firestore:', error);
            window.showCustomAlert("Gagal memuat data dari Firestore.");
            return [];
        } finally {
            window.hideLoading();
        }
    }

    // Fungsi untuk menghapus data dari Firestore
    window.deleteDataFromFirebase = async function(uniqueId) {
        window.showLoading();
        try {
            await deleteDoc(doc(db, "imunisasi", uniqueId));
            window.showCustomAlert("Data berhasil dihapus dari Firestore!");
            window.closeFullDetailModal();
            window.loadAndRenderData();
        } catch (error) {
            console.error('[deleteDataFromFirebase] Error deleting data from Firestore:', error);
            window.showCustomAlert("Gagal menghapus data dari Firestore.");
        } finally {
            window.hideLoading();
        }
    }

    window.renderDataList = async function(dataToDisplay) {
        const dataListDiv = document.getElementById('dataList');
        const loadingMessageElement = document.getElementById('loadingMessage');
        if (loadingMessageElement) {
            loadingMessageElement.classList.add('hidden');
        }
        
        dataListDiv.innerHTML = '';

        if (dataToDisplay.length === 0) {
            dataListDiv.innerHTML = '<p class="text-center text-gray-500">Tidak ada data imunisasi untuk kriteria ini.</p>';
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        dataToDisplay.forEach((item, index) => {
            const borderColorClass = 'border-blue-500';

            let statusTextColorClass = 'text-blue-800';
            const currentTtStatus = item.statusTt || 'T0';

            if (currentTtStatus === 'T5') {
                statusTextColorClass = 'text-green-700';
            } else if (currentTtStatus === 'TL') {
                statusTextColorClass = 'text-purple-700';
            } else {
                const currentTtStatusNum = parseInt(currentTtStatus.replace('T', ''));
                if (currentTtStatusNum >= 0 && currentTtStatusNum < 5) {
                    let nextScheduleDate = null;
                    if (item.jadwalDosisBerikutnya && item.jadwalDosisBerikutnya !== "Imunisasi TT lengkap (T5)" && item.jadwalDosisBerikutnya !== "Imunisasi TT lengkap (TL)") {
                        try {
                            nextScheduleDate = new Date(item.jadwalDosisBerikutnya);
                            nextScheduleDate.setHours(0, 0, 0, 0);
                        } catch (e) {
                            console.error("Invalid nextScheduleDate:", item.jadwalDosisBerikutnya, e);
                            nextScheduleDate = null;
                        }
                    }
                    if (nextScheduleDate && nextScheduleDate <= today) {
                        statusTextColorClass = 'text-yellow-700';
                    }
                }
            }

            let displayTanggalLahir = item.tanggalLahir || '-';
            if (item.tanggalLahir && typeof item.tanggalLahir === 'string') {
                const dateObj = new Date(item.tanggalLahir);
                if (!isNaN(dateObj)) {
                    displayTanggalLahir = dateObj.toLocaleDateString("id-ID", optionsShort);
                }
            }

            let displayUmurYearsOnly = '';
            if (item.umur) {
                const match = item.umur.match(/^(\d+)/);
                if (match) {
                    displayUmurYearsOnly = match[1];
                }
            }
            const displayNameAndAge = `${item.nama || '-'} (${displayUmurYearsOnly || '-'})`;

            let displayTanggalLayanan = item.tanggalLayanan || '-';
            if (item.tanggalLayanan && typeof item.tanggalLayanan === 'string') {
                const dateObj = new Date(item.tanggalLayanan);
                if (!isNaN(dateObj)) {
                    displayTanggalLayanan = dateObj.toLocaleDateString("id-ID", optionsShort);
                }
            }

            let ttBoxesHtml = '';
            let allParsedDoses = [];
            if (Array.isArray(item.ttDosesDetails)) {
                allParsedDoses = item.ttDosesDetails;
            } else if (typeof item.ttDosesDetails === 'string') {
                if (item.ttDosesDetails.startsWith('[') && item.ttDosesDetails.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(item.ttDosesDetails);
                        if (Array.isArray(parsed)) {
                            allParsedDoses = parsed;
                        }
                    } catch (e) {
                        console.warn("ttDosesDetails string did not parse to array:", item.ttDosesDetails, e);
                    }
                }
            }

            const t1ToT5DosesForColoring = allParsedDoses
                .filter(d => !d.source.startsWith('TL'))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const givenDoseNumbers = new Set();
            for (let i = 0; i < t1ToT5DosesForColoring.length && i < 5; i++) {
                givenDoseNumbers.add(i + 1);
            }
            
            const hasTL = allParsedDoses.some(d => d.source.startsWith('TL'));

            for (let i = 1; i <= 5; i++) {
                let boxClass = 'bg-gray-200';
                let boxText = `T${i}`;

                const doseGiven = givenDoseNumbers.has(i);

                if (doseGiven) {
                    boxClass = 'bg-green-500 text-white';
                } else {
                    const currentTtStatusNum = parseInt(item.statusTt ? item.statusTt.replace('T', '') : '0');
                    if (i === (currentTtStatusNum + 1)) {
                        let nextScheduleDate = null;
                        if (item.jadwalDosisBerikutnya && item.jadwalDosisBerikutnya !== "Imunisasi TT lengkap (T5)" && item.jadwalDosisBerikutnya !== "Imunisasi TT lengkap (TL)") {
                            try {
                                nextScheduleDate = new Date(item.jadwalDosisBerikutnya);
                                nextScheduleDate.setHours(0, 0, 0, 0);
                            } catch (e) {
                                console.error("Invalid nextScheduleDate:", item.jadwalDosisBerikutnya, e);
                                nextScheduleDate = null;
                            }
                        }
                        if (nextScheduleDate && nextScheduleDate <= today) {
                            boxClass = 'bg-yellow-500 text-white';
                        }
                    }
                }
                ttBoxesHtml += `<div class="tt-box ${boxClass}">${boxText}</div>`;
            }
            if (hasTL) {
                ttBoxesHtml += `<div class="tt-box bg-purple-500 text-white">TL</div>`;
            }

            let statusBadgeHtml = '';

            let phoneNumberAndIconsHtml = '';
            let formattedNoHpForLink = '';
            let isNoHpValidForAction = false;

            if (item.noHp && item.noHp.trim() !== '') {
                const cleanedNoHp = String(item.noHp).startsWith("'") ? String(item.noHp).substring(1).trim() : String(item.noHp).trim();

                if (/^08\d{8,11}$/.test(cleanedNoHp)) {
                    isNoHpValidForAction = true;
                    formattedNoHpForLink = cleanedNoHp.replace(/\D/g, '');
                    if (formattedNoHpForLink.startsWith('0')) {
                        formattedNoHpForLink = '62' + formattedNoHpForLink.substring(1);
                    } else if (!formattedNoHpForLink.startsWith('62')) {
                        formattedNoHpForLink = '62' + formattedNoHpForLink;
                    }
                }
            }
            
            const invalidNumberMessage = "Nomor HP tidak valid atau kosong. Silakan masuk ke menu edit untuk mengisi atau memperbaiki nomor HP.";
            const onClickActionInvalid = `onclick="event.stopPropagation(); window.showCustomAlert('${invalidNumberMessage}', null, '${item.uniqueId}');"`;

            const callLink = isNoHpValidForAction ? `tel:${formattedNoHpForLink}` : '#';
            const whatsappLink = isNoHpValidForAction ? `https://wa.me/${formattedNoHpForLink}` : '#';
            const disabledClass = isNoHpValidForAction ? '' : 'opacity-50 cursor-not-allowed';
            
            phoneNumberAndIconsHtml = `
                <div class="flex items-center gap-2 text-sm text-gray-700 justify-end">
                    <a href="${callLink}" ${isNoHpValidForAction ? 'target="_blank"' : onClickActionInvalid} class="text-blue-500 hover:text-blue-700 ${disabledClass}" onclick="event.stopPropagation();">
                        <i class="fas fa-phone"></i>
                    </a>
                    <a href="${whatsappLink}" ${isNoHpValidForAction ? 'target="_blank"' : onClickActionInvalid} class="text-green-500 hover:text-green-700 ${disabledClass}" onclick="event.stopPropagation();">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <span>${item.noHp ? (String(item.noHp).startsWith("'") ? String(item.noHp).substring(1) : String(item.noHp)) : '-'}</span>
                </div>
            `;

            console.log(`[renderDataList] Rendering card for ${item.nama} with uniqueId: ${item.uniqueId}`);

            const cardHtml = `
                <div class="data-card-item ${borderColorClass}" onclick="window.openFullDetailModal('${item.uniqueId}')">
                    <div class="flex justify-between items-start w-full">
                        <div class="flex-grow pr-2">
                            <p class="font-semibold text-base text-gray-800">${displayNameAndAge}</p>
                            <p class="text-sm text-gray-600">${item.nik || '-'}</p>
                            <p class="text-sm text-gray-600">${item.alamat || '-'}</p>
                        </div>
                        <div class="data-card-right-block text-right">
                            <div class="tt-boxes-container justify-end">
                                ${ttBoxesHtml}
                            </div>
                            <p class="text-sm font-bold ${statusTextColorClass} mt-1">${displayTanggalLayanan} (${item.statusTt || '-'})</p>
                            ${phoneNumberAndIconsHtml}
                            <div class="sync-badge-container text-right">
                                ${statusBadgeHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            dataListDiv.innerHTML += cardHtml;
        });

        window.updatePaginationControls();
    }

    window.loadAndRenderData = async function() {
        console.log("[loadAndRenderData] Called.");
        console.log("[loadAndRenderData] currentUserDesa:", currentUserDesa);

        if (!currentUserDesa) {
            document.getElementById('loadingMessage').innerText = 'Silahkan login untuk melihat data.';
            document.getElementById('dataList').innerHTML = '';
            console.log("[loadAndRenderData] Not logged in, clearing data list.");
            return;
        }

        const loadingMessageElement = document.getElementById('loadingMessage');
        if (loadingMessageElement) {
            loadingMessageElement.classList.remove('hidden');
            loadingMessageElement.innerText = 'Memuat data...';
        }
        
        allImunisasiData = await window.fetchDataFromFirebase();
        
        allImunisasiData.sort((a, b) => {
            const timestampA = new Date(a.timestamp || 0).getTime();
            const timestampB = new Date(b.timestamp || 0).getTime();
            return timestampB - timestampA;
        });
        
        console.log("[loadAndRenderData] Final allImunisasiData (before filter/paginate):", allImunisasiData);
        console.log("[loadAndRenderData] Total items in allImunisasiData (before filter/paginate):", allImunisasiData.length);

        window.filterAndPaginate();
        window.hideLoading();
        console.log("[loadAndRenderData] filterAndPaginate called.");
    }

    window.filterAndPaginate = function() {
        console.log("[filterAndPaginate] Called.");
        const filterText = document.getElementById('nameNikFilter').value.toLowerCase();
        let dataToConsider = [...allImunisasiData];

        if (currentUserDesa !== "AdminPuskesmas") {
            dataToConsider = dataToConsider.filter(item => String(item.desaKelurahan) === String(currentUserDesa));
        }

        if (filterText) {
            dataToConsider = dataToConsider.filter(item => 
                (String(item.nama || '').toLowerCase().includes(filterText)) || 
                (String(item.nik || '').toLowerCase().includes(filterText))
            );
        } else {
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            oneYearAgo.setHours(0, 0, 0, 0);

            dataToConsider = dataToConsider.filter(item => {
                if (item.tanggalLayanan) {
                    const itemDate = new Date(item.tanggalLayanan);
                    itemDate.setHours(0, 0, 0, 0);
                    return itemDate >= oneYearAgo;
                }
                return false;
            });
        }

        dataToConsider.sort((a, b) => {
            const timestampA = new Date(a.timestamp || 0).getTime();
            const timestampB = new Date(b.timestamp || 0).getTime();
            return timestampB - timestampA;
        });

        filteredData = dataToConsider;

        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
            console.log("[filterAndPaginate] Adjusted currentPage to:", currentPage);
        } else if (totalPages === 0) {
            currentPage = 1;
            console.log("[filterAndPaginate] No data, currentPage reset to 1.");
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const dataToDisplay = filteredData.slice(startIndex, endIndex);
        console.log("[filterAndPaginate] Data to display (paginated) length:", dataToDisplay.length);

        window.renderDataList(dataToDisplay);
    }

    window.updatePaginationControls = function() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        document.getElementById('pageInfo').innerText = `Halaman ${currentPage} dari ${totalPages || 1}`;
        document.getElementById('prevPageBtn').disabled = (currentPage === 1);
        document.getElementById('nextPageBtn').disabled = (currentPage === totalPages || totalPages === 0);
    }

    window.goToPage = function(pageNumber) {
        currentPage = pageNumber;
        window.filterAndPaginate();
    }

    window.resetForm = function() {
        document.getElementById("nik").value = "";
        document.getElementById("nama").value = "";
        document.getElementById("desaKelurahan").value = currentUserDesa === "AdminPuskesmas" ? "" : (currentUserDesa || "");
        document.getElementById("alamat").value = "";
        document.getElementById("noHp").value = "";
        document.getElementById("tanggalLahir").value = "";
        document.getElementById("umur").value = "";
        document.getElementById("tanggalLayanan").valueAsDate = new Date();
        document.getElementById("catatan").value = "";

        document.getElementById("bayiStatus").value = "Tidak";
        window.toggleSub('bayiStatus', 'subBayi');

        document.getElementById("sekolahStatus").value = "Tidak";
        window.toggleSub('sekolahStatus', 'subSekolah');

        document.getElementById("catin1").value = "";
        document.getElementById("catin2").value = "";

        const hamilContainer = document.getElementById("hamilContainer");
        while (hamilContainer.children.length > 1) {
            hamilContainer.removeChild(hamilContainer.lastChild);
        }
        hamilContainer.querySelector('input[name="hamil[]"]').value = "";

        const lainnyaContainer = document.getElementById("lainnyaContainer");
        while (lainnyaContainer.children.length > 1) {
            lainnyaContainer.removeChild(lainnyaContainer.lastChild);
        }
        lainnyaContainer.querySelector('input[name="lainnyaDate[]"]').value = "";
        lainnyaContainer.querySelector('textarea[name="lainnyaKeterangan[]"]').value = "";

        currentEditingItemUniqueId = null;
        window.hitungUmur();
        window.hitungStatusTT();
        
        window.setError('nik', 'nikError', '');
        window.setError('noHp', 'noHpError', '');
        window.setError('tanggalLahir', 'tanggalLahirError', '');
    }

    window.setFormEditState = function(isEditing) {
        const mainEditableFields = [
            'nama', 'tanggalLahir', 'nik', 'desaKelurahan', 'alamat', 'noHp', 'tanggalLayanan', 'catatan'
        ];
        mainEditableFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.disabled = false;
                element.classList.remove('bg-gray-200', 'cursor-not-allowed');
            }
        });
        document.getElementById('umur').disabled = true;
        document.getElementById('umur').classList.add('bg-gray-200', 'cursor-not-allowed');

        const historicalSectionElements = [
            document.getElementById('bayiStatus'),
            document.getElementById('sekolahStatus'),
            ...document.querySelectorAll('#subBayi input[type="checkbox"], #subBayi input[type="date"]'),
            ...document.querySelectorAll('#subSekolah input[type="checkbox"], #subSekolah input[type="date"]'),
        ];

        historicalSectionElements.forEach(element => {
            if (element) {
                element.disabled = isEditing;
                element.classList.toggle('bg-gray-200', isEditing);
                element.classList.toggle('cursor-not-allowed', isEditing);
            }
        });

        const editableDoseSections = [
            document.getElementById('catin1'),
            document.getElementById('catin2'),
            ...document.querySelectorAll('input[name="hamil[]"]'),
            ...document.querySelectorAll('input[name="lainnyaDate[]"]'),
            ...document.querySelectorAll('textarea[name="lainnyaKeterangan[]"]')
        ];

        editableDoseSections.forEach(element => {
            if (element) {
                element.disabled = false;
                element.classList.remove('bg-gray-200', 'cursor-not-allowed');
            }
        });

        const tambahKehamilanBtn = document.querySelector('button[onclick="window.tambahKehamilan()"]');
        if (tambahKehamilanBtn) {
            tambahKehamilanBtn.disabled = false;
            tambahKehamilanBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
        const tambahLainnyaBtn = document.querySelector('button[onclick="window.tambahLainnya()"]');
        if (tambahLainnyaBtn) {
            tambahLainnyaBtn.disabled = false;
            tambahLainnyaBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        }

        document.getElementById('sectionBayi').classList.toggle('opacity-70', isEditing);
        document.getElementById('sectionSekolah').classList.toggle('opacity-70', isEditing);
        
        const catinSection = document.getElementById('sectionCatin');
        if (catinSection) catinSection.classList.remove('opacity-70');
        const hamilSection = document.getElementById('sectionHamil');
        if (hamilSection) hamilSection.classList.remove('opacity-70');
        const lainnyaSection = document.getElementById('sectionLainnya');
        if (lainnyaSection) lainnyaSection.classList.remove('opacity-70');
    }

    window.editSelectedData = function(uniqueId) {
        const item = allImunisasiData.find(d => String(d.uniqueId) === String(uniqueId));
        if (!item) {
            window.showCustomAlert("Data untuk diedit tidak ditemukan.");
            return;
        }
        currentEditingItemUniqueId = item.uniqueId;
        window.showView('formView', item);
    }

    window.editDataFromAlert = function(uniqueId) {
        window.closeCustomAlert();
        const itemToEdit = allImunisasiData.find(item => String(item.uniqueId) === String(uniqueId));
        
        if (itemToEdit) {
            currentEditingItemUniqueId = itemToEdit.uniqueId;
            window.showView('formView', itemToEdit);
        } else {
            window.showCustomAlert("Data yang ingin diedit tidak ditemukan.");
        }
    }

    window.deleteData = async function(uniqueId) {
        window.closeConfirmationModal();
        await window.deleteDataFromFirebase(uniqueId);
    }

    window.openFullDetailModal = function(uniqueId) {
        const item = allImunisasiData.find(d => String(d.uniqueId) === String(uniqueId));
        if (!item) {
            window.showCustomAlert("Data detail tidak ditemukan.");
            return;
        }

        const mainContainer = document.querySelector('.main-container');
        currentScrollPosition = mainContainer ? mainContainer.scrollTop : 0;
        currentView = 'list';

        document.getElementById('topNavBar').classList.add('hidden');
        document.getElementById('mainNavBar').classList.add('hidden');
        document.querySelector('.main-container').classList.add('hidden');

        document.getElementById('detailNama').innerText = item.nama || '-';
        
        let displayTanggalLahir = item.tanggalLahir || '-';
        if (item.tanggalLahir && typeof item.tanggalLahir === 'string') {
            const dateObj = new Date(item.tanggalLahir);
            if (!isNaN(dateObj)) {
                displayTanggalLahir = dateObj.toLocaleDateString("id-ID", optionsLong);
            }
        }
        document.getElementById('detailTanggalLahir').innerText = displayTanggalLahir;
        document.getElementById('detailUmur').innerText = item.umur || '-';

        document.getElementById('detailNik').innerText = item.nik || '-';
        document.getElementById('detailDesaKelurahan').innerText = item.desaKelurahan || '-';
        document.getElementById('detailAlamat').innerText = item.alamat || '-';
        
        const displayNoHp = item.noHp ? String(item.noHp) : '';
document.getElementById('detailNoHp').innerText = displayNoHp;

        
        let displayTanggalLayanan = item.tanggalLayanan || '-';
        if (item.tanggalLayanan && typeof item.tanggalLayanan === 'string') {
                const dateObj = new Date(item.tanggalLayanan);
                if (!isNaN(dateObj)) {
                    displayTanggalLayanan = dateObj.toLocaleDateString("id-ID", optionsLong);
                }
            }
        document.getElementById('detailTanggalLayanan').innerText = displayTanggalLayanan;

        document.getElementById('detailStatusTt').innerText = item.statusTt || '-';
        
        let displayJadwalDosisBerikutnya = item.jadwalDosisBerikutnya || '-';
        if (item.statusTt === "TL") {
            displayJadwalDosisBerikutnya = "Imunisasi TT lengkap (TL)";
        } else if (item.jadwalDosisBerikutnya && item.jadwalDosisBerikutnya !== "Imunisasi TT lengkap (T5)") {
            const dateObj = new Date(item.jadwalDosisBerikutnya);
            if (!isNaN(dateObj)) {
                displayJadwalDosisBerikutnya = dateObj.toLocaleDateString("id-ID", optionsShort);
            }
        }
        document.getElementById('detailJadwalDosisBerikutnya').innerText = displayJadwalDosisBerikutnya;
        
        const dosesList = document.getElementById('detailDosesList');
        dosesList.innerHTML = '';

        let dosesArray = [];
        if (Array.isArray(item.ttDosesDetails)) {
            dosesArray = item.ttDosesDetails;
        } else if (typeof item.ttDosesDetails === 'string' && item.ttDosesDetails.startsWith('[') && item.ttDosesDetails.endsWith(']')) {
            try {
                dosesArray = JSON.parse(item.ttDosesDetails);
            } catch (e) {
                console.error("Error parsing ttDosesDetails for full detail modal:", item.ttDosesDetails, e);
            }
        }

if (dosesArray.length > 0) {
    dosesArray.forEach((dose, index) => {
        const li = document.createElement('li');
        let doseDate = dose.date || '-';
        if (dose.date && typeof dose.date === 'string') {
            const dateObj = new Date(dose.date);
            if (!isNaN(dateObj)) {
                doseDate = dateObj.toLocaleDateString("id-ID", optionsShort);
            }
        }

        let label;
        if ((dose.source || '').toUpperCase().includes('TL')) {
            label = 'TL';
        } else if ((dose.source || '').includes('Catin')) {
            label = dose.source;
        } else if ((dose.source || '').includes('Hamil')) {
            label = dose.source;
        } else if ((dose.source || '').includes('DPT')) {
            label = dose.source.replace(' (Bayi)', '');
        } else if ((dose.source || '').includes('Kelas')) {
            label = dose.source.replace(' (Sekolah)', '');
        } else {
            label = `TT${index + 1}`;
        }
        
        li.innerText = `${label} : ${doseDate} - ${dose.source || 'Tidak Diketahui'}`;
        dosesList.appendChild(li);
    });
}

        document.getElementById('detailCatatan').innerText = item.catatan || 'Tidak ada catatan.';

document.getElementById('detailUserEmail').innerText = item.userEmail || '-';

        document.getElementById('editFromFullModalBtn').onclick = () => {
            window.closeFullDetailModal();
            window.editSelectedData(item.uniqueId);
        };

        document.getElementById('deleteFromFullModalBtn').onclick = () => {
            window.showConfirmationModal("Apakah Anda yakin ingin menghapus data ini secara permanen?", () => window.deleteData(item.uniqueId));
        };

        document.getElementById('fullDetailModal').classList.remove('hidden');
    }

    window.closeFullDetailModal = function() {
        document.getElementById('fullDetailModal').classList.add('hidden');
        document.getElementById('topNavBar').classList.remove('hidden');
        document.getElementById('mainNavBar').classList.remove('hidden');
        document.querySelector('.main-container').classList.remove('hidden');
    }

    window.populateFilters = function() {
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const downloadMonthFilter = document.getElementById('downloadMonthFilter');
        const downloadYearFilter = document.getElementById('downloadYearFilter');
        const monthFilterContainer = document.getElementById('monthFilterContainer');
        const yearFilterContainer = document.getElementById('yearFilterContainer'); 

        monthFilter.innerHTML = '';
        yearFilter.innerHTML = '';
        downloadMonthFilter.innerHTML = '';
        downloadYearFilter.innerHTML = '';

        const currentYear = new Date().getFullYear();
        for (let year = currentYear - 5; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
            downloadYearFilter.appendChild(option.cloneNode(true));
        }
        yearFilter.value = currentYear;
        downloadYearFilter.value = currentYear;

        monthFilter.innerHTML = '<option value="">Semua Bulan</option>';
        downloadMonthFilter.innerHTML = '<option value="">Semua Bulan</option>';
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = (index + 1).toString().padStart(2, '0');
            option.textContent = month;
            monthFilter.appendChild(option);
            downloadMonthFilter.appendChild(option.cloneNode(true));
        });
        const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
        monthFilter.value = currentMonth;
        downloadMonthFilter.value = currentMonth;

        if (currentUserDesa === "AdminPuskesmas") {
            monthFilterContainer.classList.remove('hidden');
            yearFilterContainer.classList.remove('hidden'); 
        } else {
            monthFilterContainer.classList.add('hidden');
            yearFilterContainer.classList.remove('hidden');
            downloadMonthFilter.classList.remove('hidden'); 
            downloadMonthFilter.previousElementSibling.classList.remove('hidden');
        }
    }

    window.generateReport = async function() {
        console.log("[generateReport] Function called.");
        if (!currentUserDesa) {
            window.showCustomAlert('Silahkan login untuk melihat laporan.');
            return;
        }

        const selectedMonth = document.getElementById('monthFilter').value;
        const selectedYear = document.getElementById('yearFilter').value;
        console.log(`[generateReport] Filters: Month=${selectedMonth}, Year=${selectedYear}`);
        
        const reportTableBody = document.getElementById('reportTableBody');
        const reportTableHeader = document.getElementById('reportTableHeader');
        reportTableBody.innerHTML = '<tr><td colspan="17" class="text-center py-4 text-gray-500">Membuat laporan...</td></tr>';

        window.showLoading();

        try {
            if (allImunisasiData.length === 0) {
                console.log("[generateReport] allImunisasiData is empty, calling loadAndRenderData().");
                await window.loadAndRenderData(); 
            } else {
                console.log("[generateReport] allImunisasiData already loaded.");
            }

            let dataForReport = [];
            if (currentUserDesa === "AdminPuskesmas") {
                dataForReport = [...allImunisasiData];
                console.log("[generateReport] Admin mode: All data selected for initial processing.");
            } else {
                dataForReport = allImunisasiData.filter(item => 
                    String(item.desaKelurahan) === String(currentUserDesa)
                );
                console.log(`[generateReport] User mode (${currentUserDesa}): Data filtered by desa for initial processing. Count: ${dataForReport.length}`);
            }

            reportTableBody.innerHTML = '';

            let firstColumnHeaderText = '';
            if (currentUserDesa === "AdminPuskesmas") {
                firstColumnHeaderText = 'Desa';
            } else {
                firstColumnHeaderText = 'Bulan';
            }

            const ttHeaders = ['TT1', 'TT2', 'TT3', 'TT4', 'TT5', 'TL'];
            
            let headerHtml = `
                <tr>
                    <th rowspan="2" scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky-col">${firstColumnHeaderText}</th>
                    <th colspan="6" scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">BUMIL</th>
                    <th colspan="6" scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">#BUMIL</th>
                    <th colspan="3" scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">JUMLAH</th>
                </tr>
                <tr>
            `;
            ttHeaders.forEach(tt => {
                headerHtml += `<th scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${tt}</th>`;
            });
            ttHeaders.forEach(tt => {
                headerHtml += `<th scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${tt}</th>`;
            });
            headerHtml += `
                <th scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">BUMIL</th>
                <th scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">#BUMIL</th>
                <th scope="col" class="px-2 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL</th>
                </tr>
            `;
            reportTableHeader.innerHTML = headerHtml;


            let grandTotals = {
                TT1_Bumil: 0, TT1_NonBumil: 0,
                TT2_Bumil: 0, TT2_NonBumil: 0,
                TT3_Bumil: 0, TT3_NonBumil: 0,
                TT4_Bumil: 0, TT4_NonBumil: 0,
                TT5_Bumil: 0, TT5_NonBumil: 0,
                TL_Bumil: 0, TL_NonBumil: 0,
                sumIbuHamil: 0, 
                sumHashHamil: 0, 
                sumTotal: 0 
            };

            if (currentUserDesa === "AdminPuskesmas") {
                const aggregatedDataByDesa = {};

                dataForReport.forEach(item => {
                    const desa = String(item.desaKelurahan || 'Tidak Diketahui');
                    if (!aggregatedDataByDesa[desa]) {
                        aggregatedDataByDesa[desa] = {
                            TT1_Bumil: 0, TT1_NonBumil: 0,
                            TT2_Bumil: 0, TT2_NonBumil: 0,
                            TT3_Bumil: 0, TT3_NonBumil: 0,
                            TT4_Bumil: 0, TT4_NonBumil: 0,
                            TT5_Bumil: 0, TT5_NonBumil: 0,
                            TL_Bumil: 0, TL_NonBumil: 0,
                            totalDosesBumil: 0, 
                            totalDosesNonBumil: 0 
                        };
                    }

                    let itemDoses = [];
                    if (Array.isArray(item.ttDosesDetails)) {
                        itemDoses = item.ttDosesDetails;
                    } else if (typeof item.ttDosesDetails === 'string' && item.ttDosesDetails.startsWith('[') && item.ttDosesDetails.endsWith(']')) {
                        try {
                            itemDoses = JSON.parse(item.ttDosesDetails);
                        } catch (e) {
                            console.warn(`[generateReport-Admin] Error parsing ttDosesDetails for item ${item.uniqueId}:`, item.ttDosesDetails, e);
                        }
                    }
                    console.log(`[generateReport-Admin] Processing item ${item.uniqueId}, Desa: ${desa}, Doses:`, itemDoses);

                    itemDoses.forEach((doseEntry, doseIndex) => {
                        if (!doseEntry.date || typeof doseEntry.date !== 'string') {
                            console.warn(`[generateReport-Admin] Skipping dose due to invalid date:`, doseEntry);
                            return;
                        }
                        const doseDate = new Date(doseEntry.date);
                        if (isNaN(doseDate.getTime())) {
                            console.warn(`[generateReport-Admin] Skipping dose due to unparseable date:`, doseEntry.date);
                            return;
                        }
                        const doseMonth = (doseDate.getMonth() + 1).toString().padStart(2, '0');
                        const doseYear = doseDate.getFullYear().toString();

                        const isDoseInSelectedPeriod = 
                            (!selectedMonth || doseMonth === selectedMonth) && 
                            (!selectedYear || doseYear === selectedYear);

                        if (isDoseInSelectedPeriod) {
                            const isBumilDose = doseEntry.source.includes('Hamil');
                            const isCatinLainnyaDose = doseEntry.source.includes('Catin') || doseEntry.source.includes('Lainnya');

                            if (doseEntry.source.startsWith('TL')) {
                                if (isBumilDose) {
                                    aggregatedDataByDesa[desa].TL_Bumil++;
                                    aggregatedDataByDesa[desa].totalDosesBumil++;
                                } else if (isCatinLainnyaDose) {
                                    aggregatedDataByDesa[desa].TL_NonBumil++;
                                    aggregatedDataByDesa[desa].totalDosesNonBumil++;
                                }
                                console.log(`[generateReport-Admin] Counted TL for ${desa}. Current Bumil: ${aggregatedDataByDesa[desa].TL_Bumil}, NonBumil: ${aggregatedDataByDesa[desa].TL_NonBumil}`);
                            } else {
                                const ttNumber = doseIndex + 1; 
                                if (ttNumber >= 1 && ttNumber <= 5) {
                                    if (isBumilDose) {
                                        aggregatedDataByDesa[desa][`TT${ttNumber}_Bumil`]++;
                                        aggregatedDataByDesa[desa].totalDosesBumil++; 
                                        console.log(`[generateReport-Admin] Counted TT${ttNumber}_Bumil for ${desa}. Current:`, aggregatedDataByDesa[desa][`TT${ttNumber}_Bumil`]);
                                    } else if (isCatinLainnyaDose) {
                                        aggregatedDataByDesa[desa][`TT${ttNumber}_NonBumil`]++;
                                        aggregatedDataByDesa[desa].totalDosesNonBumil++; 
                                        console.log(`[generateReport-Admin] Counted TT${ttNumber}_NonBumil for ${desa}. Current:`, aggregatedDataByDesa[desa][`TT${ttNumber}_NonBumil`]);
                                    }
                                }
                            }
                        }
                    });
                });

                const sortedDesasToDisplay = Object.keys(aggregatedDataByDesa).sort();
                console.log("[generateReport-Admin] Aggregated data by desa:", aggregatedDataByDesa);

                if (sortedDesasToDisplay.length > 0) {
                    sortedDesasToDisplay.forEach(desa => {
                        const data = aggregatedDataByDesa[desa];
                        const row = reportTableBody.insertRow();
                        let rowHtml = `<td class="px-2 py-1 whitespace-nowrap sticky-col">${desa}</td>`;
                        ttHeaders.forEach(tt => {
                            rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data[`${tt}_Bumil`]}</td>`;
                        });
                        ttHeaders.forEach(tt => {
                            rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data[`${tt}_NonBumil`]}</td>`;
                        });
                        rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesBumil}</td>`; 
                        rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesNonBumil}</td>`; 
                        rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesBumil + data.totalDosesNonBumil}</td>`;
                        row.innerHTML = rowHtml;

                        grandTotals.TT1_Bumil += data.TT1_Bumil; grandTotals.TT1_NonBumil += data.TT1_NonBumil;
                        grandTotals.TT2_Bumil += data.TT2_Bumil; grandTotals.TT2_NonBumil += data.TT2_NonBumil;
                        grandTotals.TT3_Bumil += data.TT3_Bumil; grandTotals.TT3_NonBumil += data.TT3_NonBumil;
                        grandTotals.TT4_Bumil += data.TT4_Bumil; grandTotals.TT4_NonBumil += data.TT4_NonBumil;
                        grandTotals.TT5_Bumil += data.TT5_Bumil; grandTotals.TT5_NonBumil += data.TT5_NonBumil;
                        grandTotals.TL_Bumil += data.TL_Bumil; grandTotals.TL_NonBumil += data.TL_NonBumil;
                        grandTotals.sumIbuHamil += data.totalDosesBumil; 
                        grandTotals.sumHashHamil += data.totalDosesNonBumil; 
                        grandTotals.sumTotal += (data.totalDosesBumil + data.totalDosesNonBumil); 
                    });

                    const totalRow = reportTableBody.insertRow();
                    totalRow.className = 'total-row';
                    let totalRowHtml = `<th scope="row" class="px-2 py-1 whitespace-nowrap sticky-col">TOTAL</th>`;
                    ttHeaders.forEach(tt => {
                        totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals[`${tt}_Bumil`]}</td>`;
                    });
                    ttHeaders.forEach(tt => {
                        totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals[`${tt}_NonBumil`]}</td>`;
                    });
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumIbuHamil}</td>`;
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumHashHamil}</td>`;
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumTotal}</td>`;
                    totalRow.innerHTML = totalRowHtml;

                } else {
                    reportTableBody.innerHTML = `<tr><td colspan="17" class="text-center py-4 text-gray-500">Tidak ada data untuk laporan ini pada bulan dan tahun terpilih.</td></tr>`;
                }

            } else {
                const aggregatedDataByMonth = {};
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

                months.forEach((monthName, index) => {
                    const monthKey = (index + 1).toString().padStart(2, '0');
                    aggregatedDataByMonth[monthKey] = {
                        name: monthName,
                        TT1_Bumil: 0, TT1_NonBumil: 0,
                        TT2_Bumil: 0, TT2_NonBumil: 0,
                        TT3_Bumil: 0, TT3_NonBumil: 0,
                        TT4_Bumil: 0, TT4_NonBumil: 0,
                        TT5_Bumil: 0, TT5_NonBumil: 0,
                        TL_Bumil: 0, TL_NonBumil: 0,
                        totalDosesBumil: 0, 
                        totalDosesNonBumil: 0 
                    };
                });
                console.log("[generateReport-User] Initialized aggregatedDataByMonth:", aggregatedDataByMonth);

                dataForReport.forEach(item => {
                    let itemDoses = [];
                    if (Array.isArray(item.ttDosesDetails)) {
                        itemDoses = item.ttDosesDetails;
                    } else if (typeof item.ttDosesDetails === 'string' && item.ttDosesDetails.startsWith('[') && item.ttDosesDetails.endsWith(']')) {
                        try {
                            itemDoses = JSON.parse(item.ttDosesDetails);
                        } catch (e) {
                            console.warn(`[generateReport-User] Error parsing ttDosesDetails for item ${item.uniqueId}:`, item.ttDosesDetails, e);
                        }
                    }
                    console.log(`[generateReport-User] Processing item ${item.uniqueId}, Doses:`, itemDoses);

                    itemDoses.forEach((doseEntry, doseIndex) => {
                        if (!doseEntry.date || typeof doseEntry.date !== 'string') {
                            console.warn(`[generateReport-User] Skipping dose due to invalid date:`, doseEntry);
                            return;
                        }
                        const doseDate = new Date(doseEntry.date);
                        if (isNaN(doseDate.getTime())) {
                            console.warn(`[generateReport-User] Skipping dose due to unparseable date:`, doseEntry.date);
                            return;
                        }
                        const doseYear = doseDate.getFullYear().toString();
                        const doseMonth = (doseDate.getMonth() + 1).toString().padStart(2, '0');

                        if (doseYear === selectedYear) {
                            if (aggregatedDataByMonth[doseMonth]) {
                                const isBumilDose = doseEntry.source.includes('Hamil');
                                const isCatinLainnyaDose = doseEntry.source.includes('Catin') || doseEntry.source.includes('Lainnya');

                                if (doseEntry.source.startsWith('TL')) {
                                    if (isBumilDose) {
                                        aggregatedDataByMonth[doseMonth].TL_Bumil++;
                                        aggregatedDataByMonth[doseMonth].totalDosesBumil++;
                                    } else if (isCatinLainnyaDose) {
                                        aggregatedDataByMonth[doseMonth].TL_NonBumil++;
                                        aggregatedDataByMonth[doseMonth].totalDosesNonBumil++;
                                    }
                                    console.log(`[generateReport-User] Counted TL for month ${doseMonth}. Current Bumil: ${aggregatedDataByMonth[doseMonth].TL_Bumil}, NonBumil: ${aggregatedDataByMonth[doseMonth].TL_NonBumil}`);
                                } else {
                                    const ttNumber = doseIndex + 1;
                                    if (ttNumber >= 1 && ttNumber <= 5) {
                                        if (isBumilDose) {
                                            aggregatedDataByMonth[doseMonth][`TT${ttNumber}_Bumil`]++;
                                            aggregatedDataByMonth[doseMonth].totalDosesBumil++; 
                                            console.log(`[generateReport-User] Counted TT${ttNumber}_Bumil for month ${doseMonth}. Current:`, aggregatedDataByMonth[doseMonth][`TT${ttNumber}_Bumil`]);
                                        } else if (isCatinLainnyaDose) {
                                            aggregatedDataByMonth[doseMonth][`TT${ttNumber}_NonBumil`]++;
                                            aggregatedDataByMonth[doseMonth].totalDosesNonBumil++; 
                                            console.log(`[generateReport-User] Counted TT${ttNumber}_NonBumil for month ${doseMonth}. Current:`, aggregatedDataByMonth[doseMonth][`TT${ttNumber}_NonBumil`]);
                                        }
                                    }
                                }
                            } else {
                                console.warn(`[generateReport-User] Month key ${doseMonth} not found in aggregatedDataByMonth. This should not happen if all 12 months are initialized.`);
                            }
                        }
                    });
                });
                console.log("[generateReport-User] Aggregated data by month:", aggregatedDataByMonth);


                let hasData = false;
                months.forEach((monthName, index) => {
                    const monthKey = (index + 1).toString().padStart(2, '0');
                    const data = aggregatedDataByMonth[monthKey];
                    const row = reportTableBody.insertRow();
                    let rowHtml = `<td class="px-2 py-1 whitespace-nowrap sticky-col">${monthName}</td>`;
                    ttHeaders.forEach(tt => {
                        rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data[`${tt}_Bumil`]}</td>`;
                    });
                    ttHeaders.forEach(tt => {
                        rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data[`${tt}_NonBumil`]}</td>`;
                    });
                    rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesBumil}</td>`; 
                    rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesNonBumil}</td>`; 
                    rowHtml += `<td class="px-2 py-1 whitespace-nowrap">${data.totalDosesBumil + data.totalDosesNonBumil}</td>`;
                    row.innerHTML = rowHtml;

                    grandTotals.TT1_Bumil += data.TT1_Bumil; grandTotals.TT1_NonBumil += data.TT1_NonBumil;
                    grandTotals.TT2_Bumil += data.TT2_Bumil; grandTotals.TT2_NonBumil += data.TT2_NonBumil;
                    grandTotals.TT3_Bumil += data.TT3_Bumil; grandTotals.TT3_NonBumil += data.TT3_NonBumil;
                    grandTotals.TT4_Bumil += data.TT4_Bumil; grandTotals.TT4_NonBumil += data.TT4_NonBumil;
                    grandTotals.TT5_Bumil += data.TT5_Bumil; grandTotals.TT5_NonBumil += data.TT5_NonBumil;
                    grandTotals.TL_Bumil += data.TL_Bumil; grandTotals.TL_NonBumil += data.TL_NonBumil;
                    grandTotals.sumIbuHamil += data.totalDosesBumil; 
                    grandTotals.sumHashHamil += data.totalDosesNonBumil; 
                    grandTotals.sumTotal += (data.totalDosesBumil + data.totalDosesNonBumil); 

                    if (data.TT1_Bumil > 0 || data.TT1_NonBumil > 0 || data.TT2_Bumil > 0 || data.TT2_NonBumil > 0 || 
                        data.TT3_Bumil > 0 || data.TT3_NonBumil > 0 || data.TT4_Bumil > 0 || data.TT4_NonBumil > 0 || 
                        data.TT5_Bumil > 0 || data.TT5_NonBumil > 0 || data.TL_Bumil > 0 || data.TL_NonBumil > 0 ||
                        data.totalDosesBumil > 0 || data.totalDosesNonBumil > 0) {
                        hasData = true;
                    }
                });

                if (hasData) {
                    const totalRow = reportTableBody.insertRow();
                    totalRow.className = 'total-row';
                    let totalRowHtml = `<th scope="row" class="px-2 py-1 whitespace-nowrap sticky-col">TOTAL</th>`;
                    ttHeaders.forEach(tt => {
                        totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals[`${tt}_Bumil`]}</td>`;
                    });
                    ttHeaders.forEach(tt => {
                        totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals[`${tt}_NonBumil`]}</td>`;
                    });
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumIbuHamil}</td>`;
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumHashHamil}</td>`;
                    totalRowHtml += `<td class="px-2 py-1 whitespace-nowrap">${grandTotals.sumTotal}</td>`;
                    totalRow.innerHTML = totalRowHtml;

                } else {
                    reportTableBody.innerHTML = `<tr><td colspan="17" class="text-center py-4 text-gray-500">Tidak ada data untuk laporan ini pada tahun terpilih.</td></tr>`;
                }
            }

        } catch (error) {
            console.error('Error generating report:', error);
            reportTableBody.innerHTML = `<tr><td colspan="17" class="text-center py-4 text-red-500">Gagal membuat laporan. Error: ${error.message}</td></tr>`;
        } finally {
            window.hideLoading();
        }
    }

    window.showDownloadReportModal = function() {
        const downloadModal = document.getElementById('downloadReportModal');
        const downloadMonthFilter = document.getElementById('downloadMonthFilter');
        const downloadYearFilter = document.getElementById('downloadYearFilter');

        downloadMonthFilter.value = document.getElementById('monthFilter').value;
        downloadYearFilter.value = document.getElementById('yearFilter').value;

        downloadMonthFilter.classList.remove('hidden'); 
        downloadMonthFilter.previousElementSibling.classList.remove('hidden');

        downloadModal.classList.remove('hidden');
    }

    window.closeDownloadReportModal = function() {
        document.getElementById('downloadReportModal').classList.add('hidden');
    }

    window.downloadRecapReportCsv = function() {
    window.showLoading();

    const table = document.getElementById('reportTable');
    if (!table) {
        window.showCustomAlert('Tabel laporan tidak ditemukan.');
        window.hideLoading();
        return;
    }

    let csvContent = '';
    const headers = [];
    const headerRows = table.querySelectorAll('thead tr');

    if (headerRows.length === 2) {
        const topHeaders = Array.from(headerRows[0].querySelectorAll('th'));
        const bottomHeaders = Array.from(headerRows[1].querySelectorAll('th'));

        headers.push(topHeaders[0].textContent.trim());
        let bottomHeaderColIndex = 0;

        for (let i = 1; i < topHeaders.length; i++) {
            const th = topHeaders[i];
            const colspan = parseInt(th.getAttribute('colspan') || '1');
            const groupName = th.textContent.trim();

            for (let j = 0; j < colspan; j++) {
                const bottomHeaderCell = bottomHeaders[bottomHeaderColIndex];
                if (bottomHeaderCell) {
                    headers.push(`${groupName} ${bottomHeaderCell.textContent.trim()}`);
                }
                bottomHeaderColIndex++;
            }
        }
    } else {
        Array.from(table.querySelectorAll('thead th')).forEach(th => {
            headers.push(th.textContent.trim());
        });
    }

    csvContent += headers.map(window.sanitizeCsvField).join(',') + '\n';

    const bodyRows = table.querySelectorAll('tbody tr');
    bodyRows.forEach(row => {
        const rowData = Array.from(row.querySelectorAll('td, th'))
            .map(cell => window.sanitizeCsvField(cell.textContent.trim()));
        csvContent += rowData.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const selectedMonth = document.getElementById('monthFilter').value;
    const selectedYear = document.getElementById('yearFilter').value;
    const currentDesa = currentUserDesa;
    const monthName = selectedMonth
        ? new Date(2000, parseInt(selectedMonth) - 1, 1).toLocaleDateString('id-ID', { month: 'long' })
        : 'SemuaBulan';

    let filename = `Laporan_Rekapitulasi_Imunisasi_TT`;
    if (currentDesa === "AdminPuskesmas") {
        filename += `_${monthName}_${selectedYear}.csv`;
    } else {
        filename += `_${monthName}_${selectedYear}_${currentDesa}.csv`;
    }

    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    window.showCustomAlert('Laporan Rekapitulasi berhasil diunduh!');
    window.hideLoading();
}

// Helper: tambahkan tanda ' hanya untuk nik & noHp saat ekspor CSV
window.prefixExcelText = function(fieldName, value) {
    if (value == null) return "";
    if (fieldName !== "nik" && fieldName !== "noHp") return value;

    const s = String(value).trim();
    const normalized = s.startsWith("'") ? s.slice(1) : s; // buang ' kalau sudah ada
    return "'" + normalized;
};

// 🔑 helper untuk parsing ttDosesDetails JSON
function parseTtDoses(details) {
    const result = {
        tanggal_t1: "", status_t1: "",
        tanggal_t2: "", status_t2: "",
        tanggal_t3: "", status_t3: "",
        tanggal_t4: "", status_t4: "",
        tanggal_t5: "", status_t5: "",
        tanggal_tl: "", status_tl: "",
        tanggalTTterakhir: ""  // 🔑 kolom baru
    };

    if (!details) return result;

    let arr = [];
    try {
        arr = Array.isArray(details) ? details : JSON.parse(details);
    } catch (e) {
        console.error("Error parsing ttDosesDetails:", e);
        return result;
    }

    arr.forEach((dose, index) => {
        let key = (index < 5) ? `t${index + 1}` : `tl`;

        let formattedDate = "";
        if (dose.date) {
            const d = new Date(dose.date);
            if (!isNaN(d)) {
                formattedDate = d.toLocaleDateString("id-ID"); 
            }
        }

        result[`tanggal_${key}`] = formattedDate;
        result[`status_${key}`] = dose.source || "";
    });

    // 🔑 ambil tanggal terakhir
    if (arr.length > 0 && arr[arr.length - 1].date) {
        const d = new Date(arr[arr.length - 1].date);
        if (!isNaN(d)) {
            result.tanggalTTterakhir = d.toLocaleDateString("id-ID");
        }
    }

    return result;
}

// 🔑 fungsi utama
window.downloadIndividualReportCsv = async function() {
    window.closeDownloadReportModal();
    window.showLoading();

    const selectedMonth = document.getElementById('downloadMonthFilter').value;
    const selectedYear = document.getElementById('downloadYearFilter').value;
    const currentDesa = currentUserDesa;

    try {
        let dataToDownload = [...allImunisasiData];
        if (currentDesa !== "AdminPuskesmas") {
            dataToDownload = dataToDownload.filter(item => String(item.desaKelurahan) === String(currentDesa));
        }

        dataToDownload = dataToDownload.filter(item => {
            if (!item.tanggalLayanan) return false;
            const itemDate = new Date(item.tanggalLayanan);
            const itemMonth = (itemDate.getMonth() + 1).toString().padStart(2, '0');
            const itemYear = itemDate.getFullYear().toString();

            const matchMonth = !selectedMonth || itemMonth === selectedMonth;
            const matchYear = !selectedYear || itemYear === selectedYear;
            return matchMonth && matchYear;
        });

        if (dataToDownload.length === 0) {
            window.showCustomAlert('Tidak ada data untuk laporan pada bulan dan tahun terpilih.');
            window.hideLoading();
            return;
        }

        // 🔑 header CSV baru
        const headers = [
            'uniqueId', 'nik', 'nama', 'desaKelurahan', 'alamat', 'noHp', 'tanggalLahir', 'umur',
            'tanggalLayanan', 'tanggalTTterakhir', 'statusTt', 'jadwalDosisBerikutnya',
            'tanggal_t1', 'status_t1',
            'tanggal_t2', 'status_t2',
            'tanggal_t3', 'status_t3',
            'tanggal_t4', 'status_t4',
            'tanggal_t5', 'status_t5',
            'tanggal_tl', 'status_tl',
            'catatan', 'timestamp', 'userEmail'
        ];
        let csvContent = headers.map(window.sanitizeCsvField).join(',') + '\n';

        // 🔑 buat baris per item
        dataToDownload.forEach(item => {
            // pecah ttDosesDetails
            const tt = parseTtDoses(item.ttDosesDetails);

            const rowData = headers.map(header => {
                let value = "";

                if (header in item) {
                    value = item[header];
                } else if (header in tt) {
                    value = tt[header];
                }

                // prefix ' untuk nik & noHp agar tidak auto-format di Excel
                value = window.prefixExcelText(header, value);

                return window.sanitizeCsvField(value);
            });

            csvContent += rowData.join(',') + '\n';
        });

        // 🔑 buat blob CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        const monthName = selectedMonth
            ? new Date(2000, parseInt(selectedMonth) - 1, 1).toLocaleDateString('id-ID', { month: 'long' })
            : 'SemuaBulan';

        const filename = `Laporan_Individu_Imunisasi_TT_${monthName}_${selectedYear}_${currentDesa}.csv`;

        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        window.showCustomAlert('Laporan Individu berhasil diunduh!', null, null, true, "individu");
    } catch (error) {
        console.error(error);
        window.showCustomAlert(`Gagal mengunduh laporan. Error: ${error.message}`);
    } finally {
        window.hideLoading();
    }
}


    window.showView = function(viewId, itemData = null) {
        console.log(`[showView] Called with viewId: ${viewId}`);

        const listViewEl = document.getElementById('listView');
        const formViewEl = document.getElementById('formView');
        const reportViewEl = document.getElementById('reportView');
        const topNavBarEl = document.getElementById('topNavBar');
        const mainNavBarEl = document.getElementById('mainNavBar');
        const mainContainer = document.querySelector('.main-container');

        listViewEl.classList.add('hidden');
        formViewEl.classList.add('hidden');
        reportViewEl.classList.add('hidden');

        document.getElementById(viewId).classList.remove('hidden');
        currentView = viewId.replace('View', '');

        if (mainContainer) {
            if (viewId !== 'listView') {
                currentScrollPosition = mainContainer.scrollTop;
            }
            mainContainer.scrollTop = 0;
        }

        topNavBarEl.classList.remove('hidden');

        if (viewId === 'listView' || viewId === 'reportView') {
            mainNavBarEl.classList.remove('hidden');
        } else if (viewId === 'formView') {
            mainNavBarEl.classList.add('hidden');
        }

        if (viewId === 'listView') {
            document.getElementById('nameNikFilter').value = '';
            currentPage = 1;
            window.filterAndPaginate();
        } else if (viewId === 'formView') {
            const formTitle = document.getElementById('formTitle');
            if (!itemData) {
                console.log("[showView-formView] New entry mode. Resetting form.");
                window.resetForm(); 
                formTitle.innerText = "Form Skrining Baru";
            }
            
            if (itemData) {
                console.log("[showView-formView] Edit mode. Loading itemData:", itemData);
                formTitle.innerText = "Form Update Skrining";
                
                document.getElementById("nama").value = itemData.nama || '';
                document.getElementById("tanggalLahir").value = window.formatDateToYYYYMMDD(itemData.tanggalLahir);
                document.getElementById("umur").value = itemData.umur || '';
                document.getElementById("nik").value = itemData.nik || '';
                document.getElementById("desaKelurahan").value = itemData.desaKelurahan || '';
                document.getElementById("alamat").value = itemData.alamat || '';
                const displayNoHp = itemData.noHp ? String(itemData.noHp) : '';
document.getElementById("noHp").value = displayNoHp;
console.log("[showView-formView] Set noHp to:", document.getElementById("noHp").value);             
                document.getElementById("tanggalLayanan").value = window.formatDateToYYYYMMDD(itemData.tanggalLayanan);
                console.log("[showView-formView] Set tanggalLayanan to:", document.getElementById("tanggalLayanan").value);
                
                document.getElementById("catatan").value = itemData.catatan || '';

                let dosesArray = [];
                if (Array.isArray(itemData.ttDosesDetails)) {
                    dosesArray = itemData.ttDosesDetails;
                } else if (typeof itemData.ttDosesDetails === 'string' && itemData.ttDosesDetails.startsWith('[') && itemData.ttDosesDetails.endsWith(']')) {
                    try {
                        dosesArray = JSON.parse(itemData.ttDosesDetails);
                        console.log("[showView-formView] Parsed ttDosesDetails:", dosesArray);
                    }
                    catch (e) {
                        console.error("Error parsing ttDosesDetails for editing:", itemData.ttDosesDetails, e);
                    }
                }

                document.getElementById("bayiStatus").value = "Tidak";
                window.toggleSub('bayiStatus', 'subBayi'); 
                document.getElementById("sekolahStatus").value = "Tidak";
                window.toggleSub('sekolahStatus', 'subSekolah'); 

                dosesArray.forEach(dose => {
                    if (dose.source.startsWith('DPT')) {
                        const checkboxId = `dpt${dose.source.charAt(3)}_checkbox`;
                        const dateInputId = `dpt${dose.source.charAt(3)}_date`;
                        const checkbox = document.getElementById(checkboxId);
                        const dateInput = document.getElementById(dateInputId);
                        if (checkbox && dateInput) {
                            document.getElementById("bayiStatus").value = "Ya";
                            window.toggleSub('bayiStatus', 'subBayi');
                            checkbox.checked = true;
                            dateInput.value = window.formatDateToYYYYMMDD(dose.date);
                            console.log(`[showView-formView] Set ${checkboxId} and ${dateInputId} to ${dateInput.value}`);
                        }
                    } else if (dose.source.startsWith('Kelas')) {
                        const checkboxId = `kelas${dose.source.charAt(6)}_checkbox`;
                        const dateInputId = `kelas${dose.source.charAt(6)}_date`;
                        const checkbox = document.getElementById(checkboxId);
                        const dateInput = document.getElementById(dateInputId);
                        if (checkbox && dateInput) {
                            document.getElementById("sekolahStatus").value = "Ya";
                            window.toggleSub('sekolahStatus', 'subSekolah');
                            checkbox.checked = true;
                            dateInput.value = window.formatDateToYYYYMMDD(dose.date);
                            console.log(`[showView-formView] Set ${checkboxId} and ${dateInputId} to ${dateInput.value}`);
                        }
                    } else if (dose.source === 'Catin 1') {
                        document.getElementById("catin1").value = window.formatDateToYYYYMMDD(dose.date);
                        console.log("[showView-formView] Set catin1 to:", document.getElementById("catin1").value);
                    } else if (dose.source === 'Catin 2') {
                        document.getElementById("catin2").value = window.formatDateToYYYYMMDD(dose.date);
                        console.log("[showView-formView] Set catin2 to:", document.getElementById("catin2").value);
                    }
                });

                const hamilDoses = dosesArray.filter(d => d.source.startsWith('Hamil anak ke-') || d.source.startsWith('TL (Hamil anak ke-'));
                const hamilContainer = document.getElementById("hamilContainer");
                const initialHamilInput = hamilContainer.querySelector('input[name="hamil[]"]');
                if (initialHamilInput) {
                    initialHamilInput.value = "";
                }
                while (hamilContainer.children.length > 1) {
                    hamilContainer.removeChild(hamilContainer.lastChild);
                }
                console.log("[showView-formView] Cleared existing hamil entries.");

                if (hamilDoses.length > 0) {
                    hamilDoses.forEach((dose, index) => {
                        if (index === 0) {
                            if (initialHamilInput) {
                                initialHamilInput.value = window.formatDateToYYYYMMDD(dose.date);
                                console.log(`[showView-formView] Set initial hamil input to ${initialHamilInput.value}`);
                            }
                        } else {
                            window.tambahKehamilan();
                            const newInputs = hamilContainer.querySelectorAll('input[name="hamil[]"]');
                            const lastNewInput = newInputs[newInputs.length - 1];
                            if (lastNewInput) {
                                lastNewInput.value = window.formatDateToYYYYMMDD(dose.date);
                                console.log(`[showView-formView] Added and set new hamil input to ${lastNewInput.value}`);
                            }
                        }
                    });
                }

                const lainnyaDoses = dosesArray.filter(d => d.source.startsWith('Lainnya') || d.source.startsWith('TL (Lainnya'));
                const lainnyaContainer = document.getElementById("lainnyaContainer");
                const initialLainnyaDateInput = lainnyaContainer.querySelector('input[name="lainnyaDate[]"]');
                const initialLainnyaKeteranganInput = lainnyaContainer.querySelector('textarea[name="lainnyaKeterangan[]"]');

                if (initialLainnyaDateInput) initialLainnyaDateInput.value = "";
                if (initialLainnyaKeteranganInput) initialLainnyaKeteranganInput.value = "";

                while (lainnyaContainer.children.length > 1) {
                    lainnyaContainer.removeChild(lainnyaContainer.lastChild);
                }
                console.log("[showView-formView] Cleared existing lainnya entries.");

                if (lainnyaDoses.length > 0) {
                    lainnyaDoses.forEach((dose, index) => {
                        if (index === 0) {
                            if (initialLainnyaDateInput) {
                                initialLainnyaDateInput.value = window.formatDateToYYYYMMDD(dose.date);
                                const match = dose.source.match(/\((.*)\)/);
                                if (initialLainnyaKeteranganInput && match && match[1] && !match[1].includes('Tanpa Keterangan')) {
                                    const innerMatch = match[1].match(/\((.*)\)/);
                                    if (innerMatch) {
                                        initialLainnyaKeteranganInput.value = innerMatch[1];
                                    } else {
                                        initialLainnyaKeteranganInput.value = match[1];
                                    }
                                }
                                console.log(`[showView-formView] Set initial lainnya date to ${initialLainnyaDateInput.value}, keterangan to ${initialLainnyaKeteranganInput.value}`);
                            }
                        } else {
                            window.tambahLainnya();
                            const newDateInputs = lainnyaContainer.querySelectorAll('input[name="lainnyaDate[]"]');
                            const newKeteranganInputs = lainnyaContainer.querySelectorAll('textarea[name="lainnyaKeterangan[]"]');
                            const lastNewDateInput = newDateInputs[newDateInputs.length - 1];
                            const lastNewKeteranganInput = newKeteranganInputs[newKeteranganInputs.length - 1];
                            if (lastNewDateInput) {
                                lastNewDateInput.value = window.formatDateToYYYYMMDD(dose.date);
                                const match = dose.source.match(/\((.*)\)/);
                                if (lastNewKeteranganInput && match && match[1] && !match[1].includes('Tanpa Keterangan')) {
                                    const innerMatch = match[1].match(/\((.*)\)/);
                                    if (innerMatch) {
                                        lastNewKeteranganInput.value = innerMatch[1];
                                    } else {
                                        lastNewKeteranganInput.value = match[1];
                                    }
                                }
                                console.log(`[showView-formView] Added and set new lainnya input to ${lastNewDateInput.value}, keterangan to ${lastNewKeteranganInput.value}`);
                            }
                        }
                    });
                }

                window.hitungUmur(); 
                window.hitungStatusTT(); 
                console.log("[showView-formView] Called hitungUmur() and hitungStatusTT() after populating form.");

                window.setFormEditState(true);
            } else {
                window.setFormEditState(false);
            }
            window.setError('nik', 'nikError', '');
            window.setError('noHp', 'noHpError', '');
            window.setError('tanggalLahir', 'tanggalLahirError', '');
        } else if (viewId === 'reportView') {
            window.populateFilters();
            window.generateReport(); 
        }
    }

    window.onload = () => {
        document.getElementById('navShowListBtn').addEventListener('click', () => window.showView('listView'));
        document.getElementById('navShowReportBtn').addEventListener('click', () => window.showView('reportView'));
        document.getElementById('navShowFormBtn').addEventListener('click', () => window.showView('formView'));

        // 6. Gabungkan Semuanya di Tombol "Simpan"
        document.getElementById("saveDataButtonForm").addEventListener('click', window.saveData);
        document.getElementById("closeFormBtn").addEventListener('click', () => window.showView('listView'));

        document.getElementById('monthFilter').addEventListener('change', window.generateReport);
        document.getElementById('yearFilter').addEventListener('change', window.generateReport);
        
        document.getElementById('downloadRecapReportBtn').addEventListener('click', window.downloadRecapReportCsv);
        document.getElementById('downloadIndividualReportBtn').addEventListener('click', window.showDownloadReportModal);
        document.getElementById('confirmDownloadBtn').addEventListener('click', window.downloadIndividualReportCsv);

        document.getElementById('nameNikFilter').addEventListener('input', () => {
            currentPage = 1;
            window.filterAndPaginate();
        });

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                window.goToPage(currentPage - 1);
            }
        });
        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                window.goToPage(currentPage + 1);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', window.handleLogout);

        document.getElementById("nik").addEventListener('input', window.hitungStatusTT);
        document.getElementById("nama").addEventListener('input', window.hitungStatusTT);
        document.getElementById("umur").addEventListener('input', window.hitungStatusTT); 
        document.getElementById("desaKelurahan").addEventListener('change', window.hitungStatusTT);
        document.getElementById("alamat").addEventListener('input', window.hitungStatusTT);
        document.getElementById("noHp").addEventListener('input', window.hitungStatusTT); 
        document.getElementById("tanggalLayanan").addEventListener('change', window.hitungUmur); 
        document.getElementById("tanggalLahir").addEventListener('change', () => { 
            window.hitungUmur();
            window.hitungStatusTT();
            document.querySelectorAll('input[type="checkbox"][id$="_checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const dateInputId = checkbox.id.replace('_checkbox', '_date');
                    let type, offset;
                    if (checkbox.id.startsWith('dpt')) {
                        type = 'month';
                        if (checkbox.id === 'dpt1_checkbox') offset = 3; 
                        else if (checkbox.id === 'dpt2_checkbox') offset = 4;
                        else if (checkbox.id === 'dpt3_checkbox') offset = 5;
                        else if (checkbox.id === 'dpt4_checkbox') offset = 18;
                    } else if (checkbox.id.startsWith('kelas')) {
                        type = 'year';
                        if (checkbox.id === 'kelas1_checkbox') offset = 7;
                        else if (checkbox.id === 'kelas2_checkbox') offset = 8;
                        else if (checkbox.id === 'kelas5_checkbox') offset = 11;
                    }
                    window.calculateAndFillDate(checkbox.id, dateInputId, type, offset);
                }
            });
        });
        document.getElementById("catatan").addEventListener('input', window.hitungStatusTT);

        window.addEventListener('offline', () => {
            console.log('Koneksi internet terputus.');
            window.showCustomAlert("Koneksi internet terputus. Anda bisa terus menggunakan aplikasi secara offline.");
            window.loadAndRenderData();
            window.updateNetworkStatus();
        });
    };

    window.saveDataAndRefreshList = async function() {
        await window.saveData();
    }

    window.updateNetworkStatus = function() {
        const networkStatusIndicator = document.getElementById('networkStatusIndicator');
        const networkStatusIcon = networkStatusIndicator.querySelector('i');

        if (navigator.onLine) {
            networkStatusIcon.className = 'fas fa-wifi text-green-500';
            document.getElementById('networkStatusText').innerText = 'Online';
        } else {
            networkStatusIcon.className = 'fas fa-wifi text-gray-400';
            document.getElementById('networkStatusText').innerText = 'Offline';
        }
        networkStatusIndicator.classList.remove('hidden');
    }

    window.updateNetworkStatus();

</script>
<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
<img
  src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Official_Logo_of_Sidenreng_Rappang_Regency.png/1044px-Official_Logo_of_Sidenreng_Rappang_Regency.png"
  alt="Logo Pemda Sidrap"
  class="
    w-16 h-16
    mx-auto block mb-0
    rounded-md
    drop-shadow-[2px_4px_6px_rgba(0,0,0,0.4)]
    [transform:perspective(800px)_rotateX(5deg)_rotateY(-5deg)]
    transition-transform duration-300
    hover:scale-110 hover:rotate-0
"
/>    <p class="text-xs text-green-800 mb-0 text-center">Puskesmas Lawawoi </p>
    <p class="text-xs text-green-800 mb-4 text-center">Kec. Watang Pulu Kab.Sidrap</p>
    <h2 class="text-5xl font-bold text-blue-900 mb-0 text-center sitta-text-shadow">siTTa</h2>
    <p class="text-sm text-blue-800 mb-4 text-center">(Skrining Imunisasi Tetanus Digital)</p>
    <label class="block mb-1 text-sm font-medium text-gray-700">Desa/Kelurahan</label>
    <select id="loginDesa" class="block w-full p-2 border rounded-lg mb-4">
      <option value="">Pilih Desa</option>
      <option value="Arawa">Arawa</option>
      <option value="Bangkai">Bangkai</option>
      <option value="Batu Lappa">Batu Lappa</option>
      <option value="Buae">Buae</option>
      <option value="Carawali">Carawali</option>
      <option value="Ciro-ciroe">Ciro-ciroe</option>
      <option value="Lainungan">Lainungan</option>
      <option value="Lawawoi">Lawawoi</option>
      <option value="Mattirotasi">Mattirotasi</option>
      <option value="Uluale">Uluale</option>
      <option value="Luar Wilayah">Luar Wilayah</option>
      <option value="AdminPuskesmas">AdminPuskesmas</option>
    </select>

    <label class="block mb-1 text-sm font-medium text-gray-700">Password</label>
    <input type="password" id="loginPassword" class="block w-full p-2 border rounded-lg mb-4" placeholder="Masukkan Password">
    
    <p id="loginErrorMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>

    <button onclick="window.handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold">
      Masuk
    </button>
    <p class="text-xs text-gray-500 mt-4 text-center italic font-bold">Created by Baharuddin@2025</p>
  </div>
</div>

    <!-- Modal Login Email -->
    <div id="emailLoginModal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h2 class="text-xl font-bold mb-4 text-center">Login Email</h2>
            <p class="text-sm text-gray-600 mb-4 text-center">Masukkan email Anda untuk pertama kali menggunakan aplikasi.</p>
            <form id="emailLoginForm">
                <input type="email" id="userEmail" placeholder="nama@email.com" class="w-full p-2 border border-gray-300 rounded mb-4" required>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-300">Masuk</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Cek apakah pengguna baru
            if (!localStorage.getItem("userEmail")) {
                // Tampilkan modal login
                document.getElementById("emailLoginModal").classList.remove("hidden");
            }

            // Tangani submit form
            document.getElementById("emailLoginForm").addEventListener("submit", function(e) {
                e.preventDefault();
                const email = document.getElementById("userEmail").value;
                if (email) {
                    // Simpan email ke localStorage
                    localStorage.setItem("userEmail", email);
                    // Sembunyikan modal setelah login
                    document.getElementById("emailLoginModal").classList.add("hidden");
                    alert("Email berhasil didaftarkan: " + email);
                }
            });
        });
    </script>



<script>
  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    const installBtn = document.getElementById('installBtn');
    installBtn.classList.remove('hidden');

    installBtn.addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('Aplikasi berhasil diinstal');
          } else {
            console.log('Pengguna membatalkan instalasi');
          }
          deferredPrompt = null;
        });
      }
    });
  });
</script>
<script>
const navShowListBtn = document.getElementById("navShowListBtn");
const navShowReportBtn = document.getElementById("navShowReportBtn");
const fabTambah = document.getElementById("fabTambah");
const navShowFormBtn = document.getElementById("navShowFormBtn");

navShowListBtn.addEventListener("click", () => {
    fabTambah.classList.remove("hidden");
});

navShowReportBtn.addEventListener("click", () => {
    fabTambah.classList.add("hidden");
});

fabTambah.addEventListener("click", () => {
    navShowFormBtn.click();
});
</script>

<script>
const emailLoginModal = document.getElementById('emailLoginModal');
const emailLoginForm = document.getElementById('emailLoginForm');
const userEmailInput = document.getElementById('userEmail');
const registeredEmail = localStorage.getItem('userEmail');

// Jika email belum ada di Local Storage, tampilkan modal
if (!registeredEmail) {
    emailLoginModal.classList.remove('hidden');
}

// Tangani saat form email disubmit
emailLoginForm.addEventListener('submit', (e) => {
    e.preventDefault(); // Mencegah form untuk refresh halaman

    const email = userEmailInput.value;
    if (email) {
        // Simpan email ke Local Storage
        localStorage.setItem('userEmail', email);
        console.log('Email berhasil disimpan:', email);

        // Sembunyikan modal setelah email disimpan
        emailLoginModal.classList.add('hidden');
        
        // Di sini Anda bisa memuat konten aplikasi utama atau menampilkan pesan selamat datang
        alert('Selamat datang ' + email + '! Anda berhasil masuk.');
    } else {
        alert('Harap masukkan email yang valid.');
    }
});

// Fungsi untuk mendapatkan email yang sudah terdaftar
function getRegisteredEmail() {
    return localStorage.getItem('userEmail');
}

// Contoh penggunaan: menampilkan email di konsol saat aplikasi dimuat
if (getRegisteredEmail()) {
    console.log('Pengguna yang terdaftar:', getRegisteredEmail());
}
    // Pastikan browser mendukung Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
            .then(function(registration) {
                console.log('ServiceWorker registered with scope:', registration.scope);
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed:', err);
            });
    } else {
        console.log('Browser tidak mendukung Service Worker.');
    }

</script>
</body>
</html>
